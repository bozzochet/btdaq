<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title> AMS Software: Geometry Classes: CC/Tr.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">CC</a></div>
<h1>Tr.C</h1><a href="Tr_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00003 <span class="comment">// --- TRACKS --- //</span>
00005 <span class="comment"></span>
00006 <span class="keywordtype">int</span> TrRecon::BuildPatterns() {
00007   AddLayersCombinationPatterns(8);
00008   AddLayersCombinationPatterns(7);
00009   AddLayersCombinationPatterns(6);
00010   AddLayersCombinationPatterns(5);
00011   <span class="keywordtype">int</span>  ii = 0;
00012   <span class="keywordflow">while</span> (!(ii==(int)_Patterns.size())) {
00013     <span class="keywordflow">if</span> (!IsAllowed(_Patterns.at(ii))) _Patterns.erase(_Patterns.begin()+ii); 
00014     <span class="keywordflow">else</span> ii++;
00015   }
00016   <span class="keywordflow">return</span> _Patterns.size();
00017 }
00018 
00019 <span class="keywordtype">void</span> TrRecon::AddLayersCombinationPatterns(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> mask) {
00020   <span class="keywordtype">int</span> imask[8] = { 6, 4, 2, 5, 3, 1, 7, 0 };
00021   <span class="keywordflow">if</span> (n &gt; 0) {
00022     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i; j&lt;8; j++) AddLayersCombinationPatterns(n-1, j+1, mask | (1&lt;&lt;imask[j]));
00023     <span class="keywordflow">return</span>;
00024   }
00025   _Patterns.push_back(mask); 
00026 }
00027 
00028 <span class="keywordtype">bool</span> TrRecon::IsAllowed(<span class="keywordtype">int</span> pattern) {
00029   <span class="comment">// bit definition</span>
00030   <span class="keyword">enum</span> { B0 = 1&lt;&lt;0, B1 = 1&lt;&lt;1, B2 = 1&lt;&lt;2, B3 = 1&lt;&lt;3,
00031          B4 = 1&lt;&lt;4, B5 = 1&lt;&lt;5, B6 = 1&lt;&lt;6, B7 = 1&lt;&lt;7 };
00032   <span class="keywordtype">int</span> nlayers=0;
00033   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;8; j++) <span class="keywordflow">if</span> (pattern&amp;(1&lt;&lt;j)) nlayers++;
00034   <span class="comment">// a minimum of 5 points per track</span>
00035   <span class="keywordflow">if</span> ( nlayers&lt;5 )                             <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00036   <span class="comment">// at last 1 layer for each plane</span>
00037   <span class="keywordflow">if</span> ( ( !(pattern&amp;B1) &amp;&amp; !(pattern&amp;B2) ) ||
00038        ( !(pattern&amp;B3) &amp;&amp; !(pattern&amp;B4) ) ||
00039        ( !(pattern&amp;B5) &amp;&amp; !(pattern&amp;B6) ) )    <span class="keywordflow">return</span> <span class="keyword">false</span>;
00040   <span class="comment">// both the external planes </span>
00041   <span class="keywordflow">if</span> ( (!(pattern&amp;B0) || !(pattern&amp;B7)) ) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00042   <span class="comment">// both the external planes for the 5 point tracks </span>
00043   <span class="comment">// if ( (!(pattern&amp;B0) || !(pattern&amp;B7)) &amp;&amp; nlayers==5) return false; </span>
00044   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00045 }
00046 */
00047 
00048 <span class="comment">// void TrRecon::BuildRecHitLayerMap() {</span>
00049 <span class="comment">//   _RecHitLayerMap.clear();</span>
00050 <span class="comment">//   // loop on TrRecHits </span>
00051 <span class="comment">//   int nrechits = GetEvent()-&gt;GetnTrRecHits();</span>
00052 <span class="comment">//   for (int ihit=0; ihit&lt;nrechits; ihit++) {</span>
00053 <span class="comment">//     AMSTrRecHit* hit = GetEvent()-&gt;GetTrRecHit(ihit);</span>
00054 <span class="comment">//     int     layer = hit-&gt;GetLayer();</span>
00055 <span class="comment">//     _RecHitLayerMap[layer].push_back(hit);  </span>
00056 <span class="comment">//   }</span>
00057 <span class="comment">// }</span>
00058 
00059 
00060 <span class="comment">/*</span>
00061 <span class="comment">// COMBINATION ALGORITHM</span>
00062 <span class="comment">// layer 1, 4 hits --&gt; 0 1 2 3  0 1 2 3  0 1 2 3  0 1 2 3  0 1 2 3  0 1 2 3</span>
00063 <span class="comment">// layer 2, 2 hits --&gt; 0 0 0 0  1 1 1 1  0 0 0 0  1 1 1 1  0 0 0 0  1 1 1 1</span>
00064 <span class="comment">// layer 3, 3 hits --&gt; 0 0 0 0  0 0 0 0  1 1 1 1  1 1 1 1  2 2 2 2  2 2 2 2</span>
00065 <span class="comment">// index           --&gt; 0 1 2 3  4 5 6 7  8 91011 12131415 16171819 20212223</span>
00066 <span class="comment">// index%4         --&gt; 0 1 2 3  0 1 2 3  0 1 2 3  0 1 2 3  0 1 2 3  0 1 2 3</span>
00067 <span class="comment">// index/4         --&gt; 0 0 0 0  1 1 1 1  2 2 2 2  3 3 3 3  4 4 4 4  5 5 5 5 </span>
00068 <span class="comment">// (index/4)%2     --&gt; 0 0 0 0  1 1 1 1  0 0 0 0  1 1 1 1  0 0 0 0  1 1 1 1</span>
00069 <span class="comment">// (index/(4*2))   --&gt; 0 0 0 0  0 0 0 0  1 1 1 1  1 1 1 1  2 2 2 2  2 2 2 2</span>
00070 <span class="comment">// combinations = 4*2*3 = 24 = ntracks</span>
00071 <span class="comment">int TrRecon::BuildTrTracks() {  </span>
00072 <span class="comment"></span>
00073 <span class="comment">  BuildRecHitLayerMap();</span>
00074 <span class="comment"></span>
00075 <span class="comment">  int ncurrentlayers = 0;</span>
00076 <span class="comment">  int ntracksfounded = 0;</span>
00077 <span class="comment">  int ntracksgoodY   = 0;</span>
00078 <span class="comment">  int ntracksfitted  = 0;</span>
00079 <span class="comment">  if (_trfit==0) _trfit = new TrFit();</span>
00080 <span class="comment">  vector&lt;int&gt; multiplicity;</span>
00081 <span class="comment">  </span>
00082 <span class="comment">  // A. loop on all the possible patterns</span>
00083 <span class="comment">  int npatterns = _Patterns.size();</span>
00084 <span class="comment">  for (int pp=0; pp&lt;npatterns; pp++) {</span>
00085 <span class="comment">    int pattern = _Patterns.at(pp);</span>
00086 <span class="comment"></span>
00087 <span class="comment">    // calculation of the possible hits combination in the pattern</span>
00088 <span class="comment">    int nlayers = 0;</span>
00089 <span class="comment">    int ntracks = 1;</span>
00090 <span class="comment">    for (int ll=0; ll&lt;8; ll++) {</span>
00091 <span class="comment">      if (!(pattern&amp;(1&lt;&lt;ll))) continue;</span>
00092 <span class="comment">      int layer = ll+1;</span>
00093 <span class="comment">      int nhits = GetnTrRecHits(layer);</span>
00094 <span class="comment">      // check number of hits per plane overflow</span>
00095 <span class="comment">      if (nhits&gt;MaxNhits) nhits = 0; </span>
00096 <span class="comment">      ntracks = ntracks*nhits;</span>
00097 <span class="comment">      nlayers++;</span>
00098 <span class="comment">    }</span>
00099 <span class="comment">    // cout &lt;&lt; "pattern: " &lt;&lt; pattern &lt;&lt; " nlayers: " &lt;&lt; nlayers &lt;&lt; " nhitcombinations: " &lt;&lt; ntracks &lt;&lt; endl;</span>
00100 <span class="comment"></span>
00101 <span class="comment">    // if a saved track has a number of points greater than </span>
00102 <span class="comment">    // the used in the pattern the pattern is skipped</span>
00103 <span class="comment">    if (nlayers&lt;ncurrentlayers) continue;</span>
00104 <span class="comment"></span>
00105 <span class="comment">    // B. loop on all the possible hits combination in the pattern</span>
00106 <span class="comment">    for (int itrack=0; itrack&lt;ntracks; itrack++) {</span>
00107 <span class="comment">      // clear the hit combination list</span>
00108 <span class="comment">      _trhits.clear();</span>
00109 <span class="comment">      if (_trfit==0) _trfit = new TrFit();</span>
00110 <span class="comment">      int previous = 1;</span>
00111 <span class="comment">      int totmult = 1;</span>
00112 <span class="comment">      for (int ll=0; ll&lt;8; ll++) {</span>
00113 <span class="comment">        if (!(pattern&amp;(1&lt;&lt;ll))) continue;</span>
00114 <span class="comment">        int layer = ll+1;</span>
00115 <span class="comment">        // get the hit index for the current track</span>
00116 <span class="comment">        int nhits = GetnTrRecHits(layer);  </span>
00117 <span class="comment">        int ihit  = (itrack/previous)%nhits;</span>
00118 <span class="comment">        AMSTrRecHit* hit = GetTrRecHit(layer,ihit);</span>
00119 <span class="comment">        // set the current hit in the current combination</span>
00120 <span class="comment">        _trhits.push_back(hit);</span>
00121 <span class="comment">        previous = previous*nhits; </span>
00122 <span class="comment">        // calculate the total multiplicity of the current hit combination</span>
00123 <span class="comment">        totmult = totmult*hit-&gt;GetMultiplicity();</span>
00124 <span class="comment">      }</span>
00125 <span class="comment"></span>
00126 <span class="comment">      // cout &lt;&lt; " -------- totmultiplicity: " &lt;&lt; totmult &lt;&lt; endl; </span>
00127 <span class="comment">      YRoadCheck();</span>
00128 <span class="comment"></span>
00129 <span class="comment">      // a fast check on the Y side road </span>
00130 <span class="comment">      if (!YRoadCheck()) continue;</span>
00131 <span class="comment">      ntracksgoodY++;</span>
00132 <span class="comment">      </span>
00133 <span class="comment">      // C. loop on all the possible multiplicity for a given hit combination </span>
00134 <span class="comment">      for (int imult=0; imult&lt;totmult; imult++) {</span>
00135 <span class="comment">        _trfit-&gt;Clear();</span>
00136 <span class="comment">        multiplicity.clear();</span>
00137 <span class="comment">        int previousmult = 1;</span>
00138 <span class="comment">        for (int ll=0; ll&lt;nlayers; ll++) {</span>
00139 <span class="comment">          int hitmult  = _trhits.at(ll)-&gt;GetMultiplicity(); </span>
00140 <span class="comment">          int ihitmult = (imult/previousmult)%hitmult;</span>
00141 <span class="comment">          multiplicity.push_back(ihitmult);</span>
00142 <span class="comment">          AMSPoint point = _trhits.at(ll)-&gt;GetCoord(ihitmult);</span>
00143 <span class="comment">          // SET THE TRACK</span>
00144 <span class="comment">          _trfit-&gt;Add(point.x(),point.y(),point.z(),ErrX,ErrY,ErrZ);</span>
00145 <span class="comment">          previousmult = previousmult*hitmult;</span>
00146 <span class="comment">        }</span>
00147 <span class="comment">        // Check on the track</span>
00148 <span class="comment">        if (!ExternalPlanesRoadCheck()) continue;</span>
00149 <span class="comment">        if (!InnerTrackerCheck()) continue;</span>
00150 <span class="comment">        ntracksfitted++;</span>
00151 <span class="comment">        </span>
00152 <span class="comment">        // Add the track</span>
00153 <span class="comment">        if (_trfit-&gt;Fit()&lt;0. ) continue;</span>
00154 <span class="comment">        if (_trfit-&gt;GetChisq()&gt;1000.) continue;</span>
00155 <span class="comment">        TrTrack* track = new TrTrack(pattern,nlayers,_trhits,multiplicity,_trfit);</span>
00156 <span class="comment">        GetEvent()-&gt;AddTrTrack(track);</span>
00157 <span class="comment">        ncurrentlayers = nlayers;</span>
00158 <span class="comment">        // prenotazione degli hit????</span>
00159 <span class="comment">        // ???</span>
00160 <span class="comment">        ntracksfounded++;</span>
00161 <span class="comment">      }</span>
00162 <span class="comment">    }</span>
00163 <span class="comment">  }</span>
00164 <span class="comment">  // cout &lt;&lt; "nTracks goodY:   " &lt;&lt; ntracksgoodY   &lt;&lt; endl;</span>
00165 <span class="comment">  // cout &lt;&lt; "nTracks fitted:  " &lt;&lt; ntracksfitted  &lt;&lt; endl;</span>
00166 <span class="comment">  // cout &lt;&lt; "nTracks founded: " &lt;&lt; ntracksfounded &lt;&lt; endl;</span>
00167 <span class="comment">  return ntracksfounded;</span>
00168 <span class="comment">}</span>
00169 <span class="comment"></span>
00170 <span class="comment"></span>
00171 <span class="comment">bool TrRecon::YRoadCheck() {</span>
00172 <span class="comment">  bool check = true;</span>
00173 <span class="comment">  int  nhits = _trhits.size();</span>
00174 <span class="comment">  AMSPoint first = _trhits.at(0)-&gt;GetCoord();</span>
00175 <span class="comment">  AMSPoint last  = _trhits.at(nhits-1)-&gt;GetCoord();</span>
00176 <span class="comment">  float z0 = first.z(); </span>
00177 <span class="comment">  float z1 = last.z();</span>
00178 <span class="comment">  if (fabs(z0-z1)&lt;100.) return check;</span>
00179 <span class="comment">  // check of the hits in the road (5 cm)</span>
00180 <span class="comment">  float y0 = first.y(); </span>
00181 <span class="comment">  float y1 = last.y(); </span>
00182 <span class="comment">  float by = (y0-y1)/(z0-z1); </span>
00183 <span class="comment">  float ay = y0 - by*z0; </span>
00184 <span class="comment">  // check on the interior planes</span>
00185 <span class="comment">  for (int hh=1; hh&lt;nhits-1; hh++) {</span>
00186 <span class="comment">    AMSPoint coord = _trhits.at(hh)-&gt;GetCoord();</span>
00187 <span class="comment">    float y  = coord.y();</span>
00188 <span class="comment">    float z  = coord.z();</span>
00189 <span class="comment">    float dy = fabs(ay + by*z - y);</span>
00190 <span class="comment">    // cout &lt;&lt; hh &lt;&lt; " " &lt;&lt; y0 &lt;&lt; " " &lt;&lt; y &lt;&lt; " " &lt;&lt; y1 &lt;&lt; " --&gt; " &lt;&lt; dy &lt;&lt; endl;</span>
00191 <span class="comment">    if (dy&gt;5.) { check = false; break; }</span>
00192 <span class="comment">  }</span>
00193 <span class="comment">  return check;</span>
00194 <span class="comment">}</span>
00195 <span class="comment"></span>
00196 <span class="comment"></span>
00197 <span class="comment">bool TrRecon::ExternalPlanesRoadCheck() {</span>
00198 <span class="comment">  bool check = true;</span>
00199 <span class="comment">  int  nhits = _trfit-&gt;GetNhit();</span>
00200 <span class="comment">  // the two external planes</span>
00201 <span class="comment">  float z0 = _trfit-&gt;GetZ(0); float z1 = _trfit-&gt;GetZ(nhits-1);</span>
00202 <span class="comment">  if (fabs(z0-z1)&lt;100.) return check;</span>
00203 <span class="comment">  // check of the hits in the road (5 cm)</span>
00204 <span class="comment">  float x0 = _trfit-&gt;GetX(0); float x1 = _trfit-&gt;GetX(nhits-1); </span>
00205 <span class="comment">  float y0 = _trfit-&gt;GetY(0); float y1 = _trfit-&gt;GetY(nhits-1); </span>
00206 <span class="comment">  float bx = (x0-x1)/(z0-z1); float ax = x0 - bx*z0;   </span>
00207 <span class="comment">  float by = (y0-y1)/(z0-z1); float ay = y0 - by*z0; </span>
00208 <span class="comment">  // cout &lt;&lt; x0 &lt;&lt; " " &lt;&lt; y0 &lt;&lt; " " &lt;&lt; z0 &lt;&lt; " | " &lt;&lt; x1 &lt;&lt; " " &lt;&lt; y1 &lt;&lt; " " &lt;&lt; z1 &lt;&lt; endl;</span>
00209 <span class="comment">  // check on the interior planes</span>
00210 <span class="comment">  for (int hh=1; hh&lt;nhits-1; hh++) {</span>
00211 <span class="comment">    float x = _trfit-&gt;GetX(hh);</span>
00212 <span class="comment">    float y = _trfit-&gt;GetY(hh);</span>
00213 <span class="comment">    float z = _trfit-&gt;GetZ(hh);</span>
00214 <span class="comment">    float dx = fabs(ax + bx*z - x);</span>
00215 <span class="comment">    float dy = fabs(ay + by*z - y);</span>
00216 <span class="comment">    if ( (dx&gt;5.)||(dy&gt;5.) ) { check = false; break; }</span>
00217 <span class="comment">  }</span>
00218 <span class="comment">  return check;</span>
00219 <span class="comment">}</span>
00220 <span class="comment"></span>
00221 <span class="comment"></span>
00222 <span class="comment">bool TrRecon::InnerTrackerCheck() {</span>
00223 <span class="comment">  // two hit on the two layers of a single plane (2&amp;3, 4&amp;5, 6&amp;7) </span>
00224 <span class="comment">  // must to be similar in 5 cm (more than 70 degrees)</span>
00225 <span class="comment">  bool check = true;</span>
00226 <span class="comment">  int  nhits = _trfit-&gt;GetNhit();</span>
00227 <span class="comment">  for (int hh=0; hh&lt;nhits-1; hh++) {</span>
00228 <span class="comment">    // two hits on the two layers of a single plane (DeltaZ&lt;5.cm)</span>
00229 <span class="comment">    if (fabs(_trfit-&gt;GetZ(hh)-_trfit-&gt;GetZ(hh+1))&gt;5.) continue;</span>
00230 <span class="comment">    // probably wrong tracks (too inclinated) </span>
00231 <span class="comment">    if (fabs(_trfit-&gt;GetX(hh)-_trfit-&gt;GetX(hh+1))&gt;5.) check = false;        </span>
00232 <span class="comment">  }</span>
00233 <span class="comment">  return check;</span>
00234 <span class="comment">}</span>
00235 <span class="comment"></span>
00236 <span class="comment"></span>
00237 <span class="comment">*/</span>
00238 
00239 
<a name="l00240"></a><a class="code" href="classTrRecon.html#a27">00240</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a27">TrRecon::BuildTrTracks</a>(<span class="keywordtype">int</span> rebuild){
00241 
00242   <span class="keywordtype">int</span> ntrack = 0;
00243   <span class="keywordtype">int</span> maxtr  = <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxNtrack;
00244 
00245  <span class="comment">//Get the pointer to the TrRecHit container</span>
00246   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrRecHit"</span>);
00247   <span class="keywordflow">if</span>(!cont){
00248     printf(<span class="stringliteral">"TrRecon::BuildTrTrack  Cant Find AMSTrRecHit Container Reconstruction is Impossible !!!\n"</span>);
00249     <span class="keywordflow">return</span> -1;
00250   }
00251   <span class="keywordflow">if</span>(cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>()==0){
00252     printf(<span class="stringliteral">"TrRecon::BuildTrTrack  AMSTrRecHit Container is Empty  Reconstruction is Impossible !!!\n"</span>);
00253     <span class="keywordflow">return</span> -1;
00254   }
00255 
00256   <a class="code" href="classVCon.html">VCon</a>* cont2=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrTrack"</span>);
00257   <span class="keywordflow">if</span>(!cont2){
00258     printf(<span class="stringliteral">"TrRecon::BuildTrTrack  Cant Find AMSTrTrack Container Reconstruction is Impossible !!!\n"</span>);
00259     <span class="keywordflow">return</span> -1;
00260   }
00261 
00262 
00263   <a class="code" href="classTrRecon.html#p0">_ptest</a> = <span class="keyword">new</span> <a class="code" href="classAMSTrTrack.html">AMSTrTrack</a>();
00264 
00265   <span class="keywordflow">while</span> (ntrack &lt; maxtr) {
00266     <a class="code" href="classTrRecon.html#t0">_csqmin</a> = <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0];
00267     <a class="code" href="classTrRecon.html#p1">_ptrack</a> = 0;
00268 
00269     <span class="comment">// Scan pattern</span>
00270     <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o3">_Pattern</a> = -1;
00271     
00272     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3 &amp;&amp; !_ptrack; i++) ScanPat(i); <span class="comment">// Temporally</span>
00273 
00274     <span class="comment">// If a track is found</span>
00275     <span class="keywordflow">if</span> (_ptrack) {
00276       <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a34">Fit</a>(0);
00277       cont2-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(<a class="code" href="classTrRecon.html#p1">_ptrack</a>);
00278 
00279       <span class="comment">// Mark hits as USED</span>
00280       <span class="keywordtype">int</span> nhits = <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a11">GetNhits</a>();
00281       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nhits; i++) {
00282         <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a> *phit = <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(i);
00283         <span class="keywordflow">if</span> (phit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a>&amp;USED) phit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a> |= AMBIG;
00284         <span class="keywordflow">else</span> phit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a> |= USED;
00285 
00286         <span class="keywordflow">if</span> (phit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a> &lt; 0) phit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a> = <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#o2">_iMult</a>[i];
00287       }
00288 
00289       ntrack++;
00290       <a class="code" href="classTrRecon.html#p1">_ptrack</a> = 0;
00291     }
00292 
00293     <span class="comment">// Break if no track is found</span>
00294     <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
00295   }
00296   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00297   <span class="keywordflow">if</span>(cont2) <span class="keyword">delete</span> cont2;
00298 
00299   <span class="keywordflow">return</span> ntrack;
00300 }
00301 
00302 <span class="keywordtype">void</span>  TrRecon::ScanPat(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> mask)
00303 {
00304 
00305 
00306   <span class="comment">// Scan pattern recursively</span>
00307   <span class="keywordflow">if</span> (n &gt; 0) {
00308     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = i; j &lt; trconst::maxlay; j++)
00309       ScanPat(n-1, j+1, mask | (1&lt;&lt;j));
00310     <span class="keywordflow">return</span>;
00311   }
00312 
00313   <span class="comment">// Make a pattern vector: layer[]</span>
00314   <span class="keywordtype">int</span> layer[trconst::maxlay], nlyr = 0;
00315   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; trconst::maxlay; j++)
00316     <span class="keywordflow">if</span> (!(mask &amp; (1&lt;&lt;j))) layer[nlyr++] = j;
00317 
00318   <span class="comment">// Increment pattern ID</span>
00319   <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o3">_Pattern</a>++;
00320 
00321   <span class="comment">// Return if the pattern is not allowed</span>
00322   <span class="comment">// Not allowed pattern</span>
00323   <span class="comment">// Nly=6:     (2&amp;3) (4&amp;5) (6&amp;7)</span>
00324   <span class="comment">// Nly=5: 1 | (2&amp;3) (4&amp;5) (6&amp;7) | 8</span>
00325   <span class="keyword">enum</span> { B0 = 1&lt;&lt;0, B1 = 1&lt;&lt;1, B2 = 1&lt;&lt;2, B3 = 1&lt;&lt;3,
00326          B4 = 1&lt;&lt;4, B5 = 1&lt;&lt;5, B6 = 1&lt;&lt;6, B7 = 1&lt;&lt;7 };
00327   <span class="keywordflow">if</span> ( (mask &amp; B0 &amp;&amp; mask &amp; B7) ) <span class="keywordflow">return</span>;
00328   <span class="keywordflow">if</span> ( (mask &amp; B1 &amp;&amp; mask &amp; B2) || 
00329        (mask &amp; B3 &amp;&amp; mask &amp; B4) ||
00330        (mask &amp; B5 &amp;&amp; mask &amp; B6) ) <span class="keywordflow">return</span>;
00331   <span class="keywordflow">if</span> ( (mask &amp; B0 || mask &amp; B7) &amp;&amp; nlyr == trconst::maxlay-3) <span class="keywordflow">return</span>;
00332 
00333   <span class="comment">// Scan hits</span>
00334   <span class="keywordtype">int</span> iscan[trconst::maxlay], imult[trconst::maxlay];
00335   <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nlyr;
00336   <a class="code" href="classTrRecon.html#a29">ScanHit</a>(layer, iscan, imult);
00337 }
00338 
00339 
00340 
00341 
<a name="l00342"></a><a class="code" href="classTrRecon.html#a29">00342</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a29">TrRecon::ScanHit</a>(<span class="keywordtype">int</span> *layer, <span class="keywordtype">int</span> *iscan, <span class="keywordtype">int</span> *imult, <span class="keywordtype">int</span> i)
00343 {
00344   <span class="comment">// Clear hits vector</span>
00345   <span class="keywordflow">if</span> (i == 0) <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; trconst::maxlay; j++) <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o0">_Hits</a>[j] = 0;
00346 
00347   <span class="keywordtype">int</span> nhits = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a>;
00348 
00349   <span class="comment">// Evaluate a track</span>
00350   <span class="keywordflow">if</span> (i == nhits) {
00351 
00352     <span class="comment">// Ambiguity check</span>
00353     <span class="keywordflow">if</span> (layer[0] != 0 &amp;&amp; layer[nhits-1] != trconst::maxlay-1) <span class="keywordflow">return</span>;
00354 
00355     <span class="comment">// Fit and check chisquare</span>
00356     <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>() &lt; <a class="code" href="classTrRecon.html#t0">_csqmin</a> &amp;&amp; <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a34">Fit</a>(0) &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[1]) {
00357 
00358       <span class="comment">// Replace the track candidate</span>
00359       <span class="keywordflow">if</span> (!_ptrack) <a class="code" href="classTrRecon.html#p1">_ptrack</a> = <span class="keyword">new</span> <a class="code" href="classAMSTrTrack.html">AMSTrTrack</a>;
00360       *<a class="code" href="classTrRecon.html#p1">_ptrack</a> = *_ptest;
00361       <a class="code" href="classTrRecon.html#t0">_csqmin</a> = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a29">GetChisqWoMS</a>();
00362     }
00363 
00364     <span class="keywordflow">return</span>;
00365   }
00366 
00367   <span class="comment">// Loop for each hit in the layer</span>
00368   
00369  <span class="comment">//Get the pointer to the TrRecHit container</span>
00370   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrRecHit"</span>);
00371 
00372   <span class="keywordtype">int</span> nscan = cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>();
00373   <span class="keywordflow">for</span> (iscan[i] = 0; iscan[i] &lt; nscan; iscan[i]++) {
00374 
00375     <span class="comment">// Get and check a hit</span>
00376     <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a> *hit = (<a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a>*)cont-&gt;<a class="code" href="classVCon.html#a5">getelem</a>(iscan[i]);
00377     <span class="keywordflow">if</span> (hit-&gt;<a class="code" href="classAMSTrRecHit.html#a7">GetLayer</a>() != layer[i]+1) <span class="keywordflow">continue</span>;
00378     <span class="keywordflow">if</span> ((hit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a>&amp;USED) &amp;&amp; hit-&gt;<a class="code" href="classAMSTrRecHit.html#a7">GetLayer</a>() &gt; 2) <span class="keywordflow">continue</span>;
00379     <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o0">_Hits</a>[i] = hit;
00380     <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o2">_iMult</a>[i] = 0;
00381 
00382     <span class="comment">// Optimization only for non-B run: Check with only Y-side</span>
00383     <span class="keywordflow">if</span> (MAGSFFKEY.magstat == 0 &amp;&amp; i &gt;= 2) {
00384       <span class="keywordtype">double</span> err[3] = { 0, 0.03, 0.03 };
00385 
00386       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = i+1;
00387       <span class="keywordtype">double</span> csq = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>(err);
00388       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nhits;
00389       <span class="keywordflow">if</span> (csq &gt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0]) <span class="keywordflow">continue</span>;
00390     }
00391 
00392     <span class="keywordtype">int</span> nmult = hit-&gt;<a class="code" href="classAMSTrRecHit.html#a14">GetMultiplicity</a>(), im0 = 0;
00393 
00394     <span class="comment">// Fix multiplicity index if already determined</span>
00395     <span class="keywordflow">if</span> (hit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a> &gt;= 0) { 
00396       im0 = hit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a>; 
00397       nmult = im0+1; 
00398     }
00399 
00400     <span class="comment">// Tighten multiplicity range if the previous layer is on the same plane</span>
00401     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &gt; 0 &amp;&amp; 
00402              (layer[i-1] == 1 || layer[i-1] == 3 || layer[i-1] == 5) &amp;&amp;
00403              layer[i-1]+1 == layer[i]) {
00404       im0   = std::max(imult[i-1]-1, 0);
00405       nmult = std::min(imult[i-1]+2, hit-&gt;<a class="code" href="classAMSTrRecHit.html#a14">GetMultiplicity</a>());
00406     }
00407 
00408     <span class="comment">// Loop for each multiplicity</span>
00409     <span class="keywordflow">for</span> (imult[i] = im0; imult[i] &lt; nmult; imult[i]++) {
00410 
00411       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o2">_iMult</a>[i] = imult[i];
00412 
00413       <span class="comment">// Optimization only for non-B run: Check with only X-side</span>
00414       <span class="keywordflow">if</span> (MAGSFFKEY.magstat == 0 &amp;&amp; i &gt;= 2) {
00415         <span class="keywordtype">double</span> err[3] = { 0.03, 0, 0.03 };
00416 
00417         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = i+1;
00418         <span class="keywordtype">double</span> csq = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>(err);
00419         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nhits;
00420         <span class="keywordflow">if</span> (csq &gt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0]) <span class="keywordflow">continue</span>;
00421       }
00422 
00423       <span class="keywordflow">else</span> {
00424 
00425       <span class="comment">// Make a quick check parameter</span>
00426       <span class="keywordflow">if</span> (i == 2) {
00427         AMSPoint x0 = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(0)-&gt;<a class="code" href="classAMSTrRecHit.html#a15">GetCoord</a>(imult[0]);
00428         AMSPoint x2 = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(2)-&gt;<a class="code" href="classAMSTrRecHit.html#a15">GetCoord</a>(imult[2]);
00429 
00430         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0] = (x2[0]-x0[0])/(x2[2]-x0[2]);
00431         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0] = (x2[1]-x0[1])/(x2[2]-x0[2]);
00432         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][1] =  x0[0]-<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]*x0[2];
00433         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][1] =  x0[1]-<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]*x0[2];
00434         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][2] = sqrt(1+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]*<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]);
00435         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][2] = sqrt(1+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]*<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]);
00436       }
00437 
00438       <span class="comment">// Quick check</span>
00439       <span class="keywordflow">if</span> (i &gt;= 2) {
00440         <span class="keywordtype">int</span> l = (i == 2) ? 1 : i;
00441         AMSPoint x1 = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(l)-&gt;<a class="code" href="classAMSTrRecHit.html#a15">GetCoord</a>(imult[l]);
00442 
00443         <span class="keywordflow">if</span> ( !(fabs(<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][1]+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]*x1[2]-x1[0]) 
00444                &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.SearchRegStrLine*<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][2] &amp;&amp;
00445                fabs(<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][1]+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]*x1[2]-x1[1]) 
00446                &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.SearchRegCircle *<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][2]) ) <span class="keywordflow">continue</span>;
00447 
00448         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = i+1;
00449         <span class="keywordtype">double</span> csq = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>();
00450         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nhits;
00451         <span class="keywordflow">if</span> (csq &gt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0]) <span class="keywordflow">continue</span>;
00452       }
00453 
00454       }
00455 
00456       <span class="comment">// Go to the next layer</span>
00457       <a class="code" href="classTrRecon.html#a29">ScanHit</a>(layer, iscan, imult, i+1);
00458     }
00459   }
00460 
00461   <span class="keywordflow">if</span> (cont) <span class="keyword">delete</span> cont;
00462 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Nov 18 18:21:03 2008 for  AMS Software: Geometry Classes by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
