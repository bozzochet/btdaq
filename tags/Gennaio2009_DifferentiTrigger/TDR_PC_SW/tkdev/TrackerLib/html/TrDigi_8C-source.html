<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title> AMS Software: Geometry Classes: CC/TrDigi.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">CC</a></div>
<h1>TrDigi.C</h1><a href="TrDigi_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">//  $Id: TrDigi.C,v 1.1 2008/07/30 16:58:29 zuccon Exp $</span>
00002 
00016 
00017 <span class="preprocessor">#include "<a class="code" href="TrDigi_8h.html">TrDigi.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="TrMCCluster_8h.html">TrMCCluster.h</a>"</span>
00019 <span class="preprocessor">#include "TrGeom.h"</span>
00020 <span class="preprocessor">#include "<a class="code" href="TrCalDB_8h.html">TrCalDB.h</a>"</span>
00021 
00022 <span class="preprocessor">#include &lt;cmath&gt;</span>
00023 
<a name="l00024"></a><a class="code" href="classTrDigi.html#s0">00024</a> <span class="keywordtype">int</span>   <a class="code" href="classTrDigi.html#s0">TrDigi::adcoverflow</a> = 32700;
<a name="l00025"></a><a class="code" href="classTrDigi.html#s1">00025</a> <span class="keywordtype">float</span> <a class="code" href="classTrDigi.html#s1">TrDigi::thr1R</a>[2] = { 3, 3.5 };<span class="comment">//{ -2.75, 3.5 };</span>
<a name="l00026"></a><a class="code" href="classTrDigi.html#s2">00026</a> <span class="keywordtype">float</span> <a class="code" href="classTrDigi.html#s2">TrDigi::thr2R</a>[2] = { 1, 1 };
<a name="l00027"></a><a class="code" href="classTrDigi.html#s3">00027</a> <span class="keywordtype">int</span>   <a class="code" href="classTrDigi.html#s3">TrDigi::neib</a> [2] = { 0, 1 };
<a name="l00028"></a><a class="code" href="classTrDigi.html#s4">00028</a> <span class="keywordtype">int</span>   <a class="code" href="classTrDigi.html#s4">TrDigi::CalcCmnNoise</a>[2] = { 1, 0 };
00029 
<a name="l00030"></a><a class="code" href="classTrDigi.html#s5">00030</a> <span class="keywordtype">int</span> <a class="code" href="classTrDigi.html#s5">TrDigi::VAchannels</a> = 64;
00031 
<a name="l00032"></a><a class="code" href="classTrDigi.html#s6">00032</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classTrDigi.html#s6">TrDigi::MATCHED</a>=1;
00033 
<a name="l00034"></a><a class="code" href="classTrDigi.html#s7">00034</a> <span class="keywordtype">float</span> <a class="code" href="classTrDigi.html#s7">TrDigi::CmnNoise</a>[10][4000];
00035 
<a name="l00036"></a><a class="code" href="classTrDigi.html#t0">00036</a> std::vector&lt;TrDigi *&gt; TrDigi::_cont;
00037 
<a name="l00038"></a><a class="code" href="classTrDigi.html#a1">00038</a> <a class="code" href="classTrDigi.html#a1">TrDigi::~TrDigi</a>(){
00039   <span class="keyword">delete</span> [] _array;
00040 }
00041 
<a name="l00042"></a><a class="code" href="classTrDigi.html#a0">00042</a> <a class="code" href="classTrDigi.html#a0">TrDigi::TrDigi</a>(<span class="keywordtype">int</span> ad, <span class="keywordtype">int</span> left, <span class="keywordtype">int</span> right, 
00043                <span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> s2n)
00044   :_address(ad),_strip(left),_nelem(right-left+1),_s2n(s2n){
00045     <a class="code" href="classTrDigi.html#p5">_array</a>=<span class="keyword">new</span> <span class="keywordtype">int</span>[_nelem];
00046     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0;k&lt;_nelem;k++)<a class="code" href="classTrDigi.html#p5">_array</a>[k]=int(*(p+k));  
00047 }
00048 
00049 <span class="keywordtype">void</span> <a class="code" href="classTrDigi.html#b0">TrDigi::_printEl</a>(ostream &amp; stream)
00050 {
00051   stream &lt;&lt;_address&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;_strip&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;_nelem&lt;&lt;endl;
00052 }
00053 
<a name="l00054"></a><a class="code" href="classTrDigi.html#e1">00054</a> <span class="keywordtype">void</span> <a class="code" href="classTrDigi.html#e1">TrDigi::matchKS</a>()
00055 {
00056   <span class="comment">// Get rid of K without S </span>
00057   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTrDigi.html#e3">TrDigi::GetN</a>(); i++) {
00058     <a class="code" href="classTrDigi.html">TrDigi</a> *pk=<a class="code" href="classTrDigi.html#e4">TrDigi::At</a>(i);
00059 
00060     <span class="keywordtype">int</span> ktkid = pk-&gt;<a class="code" href="classTrDigi.html#p1">_address</a>%2000-1000;
00061     <span class="keywordtype">int</span> kside = pk-&gt;<a class="code" href="classTrDigi.html#p1">_address</a>/2000;
00062     <span class="keywordflow">if</span> (kside != 0) <span class="keywordflow">continue</span>;
00063 
00064     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = i; j &lt; <a class="code" href="classTrDigi.html#e3">TrDigi::GetN</a>(); j++) {
00065       <a class="code" href="classTrDigi.html">TrDigi</a> *ps=<a class="code" href="classTrDigi.html#e4">TrDigi::At</a>(j);
00066 
00067       <span class="keywordtype">int</span> stkid = ps-&gt;<a class="code" href="classTrDigi.html#p1">_address</a>%2000-1000;
00068       <span class="keywordtype">int</span> sside = ps-&gt;<a class="code" href="classTrDigi.html#p1">_address</a>/2000;
00069 
00070       <span class="keywordflow">if</span>(sside == 1 &amp;&amp; stkid == ktkid) {
00071         pk-&gt;<a class="code" href="classTrDigi.html#a4">setstatus</a>(<a class="code" href="classTrDigi.html#s6">TrDigi::MATCHED</a>);
00072         <span class="keywordflow">break</span>;
00073       }
00074     }
00075 
00076   }
00077 }
00078 
00079 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">double</span> <a class="code" href="TrDigi_8C.html#a0">rnormx</a>();
00080 
<a name="l00081"></a><a class="code" href="classTrDigi.html#e0">00081</a> <span class="keywordtype">void</span> <a class="code" href="classTrDigi.html#e0">TrDigi::sitkdigi</a>()
00082 {
00083   <span class="comment">// set defaults</span>
00084   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; TrMCCluster::GetN(); i++) {
00085     TrMCCluster *ptrhit = TrMCCluster::At(i);
00086     <span class="keywordflow">if</span>(ptrhit-&gt;IsNoise())ptrhit-&gt;<a class="code" href="classTrDigi.html#a4">setstatus</a>(TrMCCluster::AwayTOF);
00087   }
00088 
00089   <span class="keyword">const</span> <span class="keywordtype">int</span> ms=4000;
00090   <span class="keyword">const</span> <span class="keywordtype">int</span> maxva=64;
00091   <span class="keyword">static</span> <span class="keywordtype">float</span>* ida[ms];
00092   <span class="keywordtype">float</span> idlocal[maxva];
00093 
00094   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ms; i++) ida[i] = 0;
00095 
00096   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; TrMCCluster::GetN(); i++) {
00097     TrMCCluster *ptr = TrMCCluster::At(i);
00098     ptr-&gt;addcontent(<span class="charliteral">'x'</span>,ida);
00099     ptr-&gt;addcontent(<span class="charliteral">'y'</span>,ida);
00100   }
00101 
00102   <span class="comment">//</span>
00103   <span class="comment">// add sigmas &amp; calculate properly cmnnoise</span>
00104   <span class="comment">//</span>
00105 
00106   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ms; i++) {
00107     <span class="keywordflow">if</span>(!ida[i]) <span class="keywordflow">continue</span>;
00108 
00109     <span class="keywordtype">int</span> tkid  = i%2000-1000;
00110     <span class="keywordtype">int</span> side  = i/2000;
00111     <span class="keywordtype">int</span> offs  = (side == 0) ? TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o29">_NReadoutChanS</a> : 0;
00112     <span class="keywordtype">int</span> layer = std::abs(tkid)/100;
00113 
00114     <a class="code" href="classTrLadCal.html">TrLadCal</a> *tcal = TrCalDB::Head-&gt;<a class="code" href="classTrCalDB.html#a10">FindCal_TkId</a>(tkid);
00115     <span class="keywordflow">if</span> (!tcal) {
00116       <span class="keywordflow">continue</span>;
00117       std::cerr &lt;&lt; <span class="stringliteral">"ERROR(1) tcal not found: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00118     }
00119 
00120     <span class="keywordtype">int</span> ndrp = (side == 0) ? TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o30">_NReadoutChanK</a> 
00121                            : TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o29">_NReadoutChanS</a>;
00122 
00123     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; ndrp; j++) {
00124       <span class="keywordflow">if</span>(*(ida[i]+j)){
00125         <span class="keywordtype">int</span>  vanum = j/VAchannels;
00126         <span class="keywordtype">int</span>  strpa = j%VAchannels;
00127         <span class="keywordtype">int</span>  vamin = j-strpa;
00128         <span class="keywordtype">int</span>  vamax = j+maxva-strpa;
00129         <span class="keywordtype">float</span> ecmn = <a class="code" href="classTrDigi.html#s7">CmnNoise</a>[vanum][i]*<a class="code" href="TrDigi_8C.html#a0">rnormx</a>();
00130 
00131         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l = vamin; l &lt; vamax; l++) {
00132           *(ida[i]+l) += tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(l+offs)*<a class="code" href="TrDigi_8C.html#a0">rnormx</a>()+ecmn;
00133           idlocal[l-vamin] = *(ida[i]+l);
00134         }
00135 
00136         <span class="keywordtype">float</span> cmn = 0;
00137         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l = <a class="code" href="classTrDigi.html#s4">CalcCmnNoise</a>[1]; l &lt; maxva-<a class="code" href="classTrDigi.html#s4">CalcCmnNoise</a>[1]; l++)
00138           cmn += idlocal[l];
00139         cmn = cmn/(maxva-2*CalcCmnNoise[1]);
00140 
00141         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = vamin; l &lt; vamax; l++)
00142           *(ida[i]+l) = *(ida[i]+l)-cmn;
00143         j = vamax;
00144       }
00145     }
00146   }
00147 
00148   <span class="comment">// Add noise now</span>
00149   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; TrMCCluster::GetN(); i++) {
00150     TrMCCluster *ptr = TrMCCluster::At(i);
00151     ptr-&gt;addcontent(<span class="charliteral">'x'</span>,ida,1);
00152     ptr-&gt;addcontent(<span class="charliteral">'y'</span>,ida,1);
00153   }
00154 
00155   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ms; i++) {
00156     <span class="keywordflow">if</span> (!ida[i]) <span class="keywordflow">continue</span>;
00157 
00158     <span class="keywordtype">int</span> tkid  = i%2000-1000;
00159     <span class="keywordtype">int</span> side  = i/2000;
00160     <span class="keywordtype">int</span> layer = std::abs(tkid)/100;
00161     <span class="keywordtype">int</span> offs  = (side == 0) ? TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o29">_NReadoutChanS</a> : 0;
00162     <span class="keywordtype">int</span> ndrp  = (side == 0) ? TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o30">_NReadoutChanK</a> 
00163                             : TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o29">_NReadoutChanS</a>;
00164 
00165     <a class="code" href="classTrLadCal.html">TrLadCal</a> *tcal = TrCalDB::Head-&gt;<a class="code" href="classTrCalDB.html#a10">FindCal_TkId</a>(tkid);
00166     <span class="keywordflow">if</span> (!tcal) {
00167       <span class="keywordflow">continue</span>;
00168       std::cerr &lt;&lt; <span class="stringliteral">"ERROR(2) tcal not found: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00169     }
00170 
00171     <a class="code" href="classTrDigi.html">TrDigi</a> *pcl = 0;
00172     <span class="keywordtype">int</span> nlmin;
00173     <span class="keywordtype">int</span> nleft=0;
00174     <span class="keywordtype">int</span> nright=0;
00175 
00176     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; ndrp; j++) {
00177       <span class="keywordtype">float</span> s2n=0;
00178       <span class="keywordflow">if</span>(tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(j+offs)&gt;0 &amp;&amp; 
00179          *(ida[i]+j)&gt; <a class="code" href="classTrDigi.html#s1">thr1R</a>[side]*tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(j+offs)){
00180         s2n= *(ida[i]+j)/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(j+offs);
00181         nlmin = nright==0?0:nright+1;
00182 
00183         nleft = std::max(j-<a class="code" href="classTrDigi.html#s3">neib</a>[side],nlmin); 
00184         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nlf = nleft; nlf &gt; nlmin; --nlf) {
00185           <span class="keywordflow">if</span>(*(ida[i]+nlf)&lt;= <a class="code" href="classTrDigi.html#s2">thr2R</a>[side]*tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(nlf+offs))<span class="keywordflow">break</span>;
00186           <span class="keywordflow">else</span> nleft=nlf;
00187         }
00188 
00189         nright = std::min(j+<a class="code" href="classTrDigi.html#s3">neib</a>[side],ndrp-1);
00190         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nrt = nright; nrt &lt; ndrp-1; ++nrt) {
00191           <span class="keywordflow">if</span>(*(ida[i]+nrt)&lt;= <a class="code" href="classTrDigi.html#s2">thr2R</a>[side]*tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(nrt+offs))<span class="keywordflow">break</span>;
00192           <span class="keywordflow">else</span> nright=nrt;
00193         }
00194 
00195         <span class="keywordtype">double</span> sum = 0;
00196         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = nleft; k &lt;= nright; k++) sum += *(ida[i]+k);
00197 
00198         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = nleft; k &lt;= nright; k++) {
00199           <span class="keywordtype">int</span> vanum = k/VAchannels;
00200           (*(ida[i]+k))*=8;
00201           <span class="keywordtype">double</span> addon=(tcal-&gt;<a class="code" href="classTrLadCal.html#a5">Pedestal</a>(k+offs)+
00202                         <a class="code" href="classTrDigi.html#s7">CmnNoise</a>[vanum][i]+sum/maxva)*8;
00203           <span class="keywordflow">if</span>(*(ida[i]+k) +addon&gt; adcoverflow){
00204             *(ida[i]+k)=<a class="code" href="classTrDigi.html#s0">adcoverflow</a>-addon;
00205           }
00206           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*(ida[i]+k) +addon&lt;0){
00207             *(ida[i]+k)=0-addon;
00208           }            
00209           <span class="keywordflow">if</span>(*(ida[i]+k)&gt;32767)*(ida[i]+k)=32767;
00210           <span class="keywordflow">if</span>(*(ida[i]+k)&lt;-32767)*(ida[i]+k)=-32767;
00211         }
00212         pcl= <span class="keyword">new</span> <a class="code" href="classTrDigi.html#a0">TrDigi</a>(i,nleft,nright,ida[i]+nleft,s2n);
00213         <a class="code" href="classTrDigi.html#t0">_cont</a>.push_back(pcl);
00214         j=nright+1;           
00215       }
00216     }
00217     <span class="keyword">delete</span> [] ida[i];
00218     ida[i] = 0;
00219   }
00220 
00221   <a class="code" href="classTrDigi.html#e1">matchKS</a>();
00222 }
00223 
00224 <span class="preprocessor">#include &lt;fstream&gt;</span>
00225 
<a name="l00226"></a><a class="code" href="classTrDigi.html#e2">00226</a> <span class="keywordtype">int</span> <a class="code" href="classTrDigi.html#e2">TrDigi::ReadCmnNoise</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname)
00227 {
00228   std::ifstream fin(fname);
00229   <span class="keywordflow">if</span> (!fin) <span class="keywordflow">return</span> -1;
00230 
00231   fin.read((<span class="keywordtype">char</span>*)<a class="code" href="classTrDigi.html#s7">CmnNoise</a>, 4*10*4000);
00232   std::cout &lt;&lt;<span class="stringliteral">"AMSTimeID::read-I-Open file "</span> &lt;&lt; fname &lt;&lt; std::endl;
00233   <span class="keywordflow">return</span> 0;
00234 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Nov 18 18:21:03 2008 for  AMS Software: Geometry Classes by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
