<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title> AMS Software: Geometry Classes: CC/AlignFit.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">CC</a></div>
<h1>AlignFit.C</h1><a href="AlignFit_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">// $Id: AlignFit.C,v 1.3 2008/05/22 20:30:52 haino Exp $</span>
00002 
00014 
00015 <span class="preprocessor">#include "<a class="code" href="AlignFit_8h.html">AlignFit.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="TkDBc_8h.html">TkDBc.h</a>"</span>
00017 
00018 <span class="preprocessor">#include "TROOT.h"</span>
00019 <span class="preprocessor">#include "TH1.h"</span>
00020 <span class="preprocessor">#include "TH2.h"</span>
00021 <span class="preprocessor">#include "TH3.h"</span>
00022 <span class="preprocessor">#include "TF1.h"</span>
00023 <span class="preprocessor">#include "TMath.h"</span>
00024 <span class="preprocessor">#include "TString.h"</span>
00025 <span class="preprocessor">#include "TStopwatch.h"</span>
00026 <span class="preprocessor">#include "TSystem.h"</span>
00027 
00028 <span class="preprocessor">#include &lt;iostream&gt;</span>
00029 <span class="preprocessor">#include &lt;fstream&gt;</span>
00030 
<a name="l00031"></a><a class="code" href="classAlignObject.html#s0">00031</a> TObjArray AlignObject::sharray;
<a name="l00032"></a><a class="code" href="classAlignObject.html#s1">00032</a> Int_t <a class="code" href="classAlignObject.html#s1">AlignObject::ProfMode</a> = 0;
00033 
<a name="l00034"></a><a class="code" href="classAlignObject.html#a0">00034</a> <a class="code" href="classAlignObject.html#a0">AlignObject::AlignObject</a>(Int_t <span class="keywordtype">id</span>) : tkid(id)
00035 {
00036   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nalg; i++) <a class="code" href="classAlignObject.html#o1">fixp</a>[i] = 0;
00037 }
00038 
<a name="l00039"></a><a class="code" href="classAlignObject.html#a1">00039</a> <a class="code" href="classAlignObject.html#a1">AlignObject::~AlignObject</a>()
00040 {
00041 }
00042 
<a name="l00043"></a><a class="code" href="classAlignObject.html#a3">00043</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#a3">AlignObject::Reset</a>(<span class="keywordtype">void</span>)
00044 {
00045   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Ndim; i++) <a class="code" href="classAlignObject.html#o2">param</a>[i] = 0;
00046   <a class="code" href="classAlignObject.html#o4">phi</a> = <a class="code" href="classAlignObject.html#o6">pitch</a> = <a class="code" href="classAlignObject.html#o8">roll</a> = 0;
00047 }
00048 
<a name="l00049"></a><a class="code" href="classAlignObject.html#e0">00049</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#e0">AlignObject::InitSHists</a>(<span class="keywordtype">void</span>)
00050 {
00051   <a class="code" href="classAlignObject.html#s0">sharray</a>.Clear();
00052   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist1"</span>, <span class="stringliteral">"Fitpar (X)"</span>,     256, 0.5, 256.5));
00053   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist2"</span>, <span class="stringliteral">"Fitpar (Y)"</span>,     256, 0.5, 256.5));
00054   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist3"</span>, <span class="stringliteral">"Fitpar (Z)"</span>,     256, 0.5, 256.5));
00055   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist4"</span>, <span class="stringliteral">"Fitpar (dY/dX)"</span>, 256, 0.5, 256.5));
00056   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist5"</span>, <span class="stringliteral">"Fitpar (dZ/dX)"</span>, 256, 0.5, 256.5));
00057   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist0"</span>, <span class="stringliteral">"X-Scale"</span>,        256, 0.5, 256.5));
00058   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH3F(<span class="stringliteral">"histx"</span>, <span class="stringliteral">"Residual VS angle (X)"</span>, 
00059                        256, 0.5, 256.5, 20, -1, 1, 100, -1, 1));
00060   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH3F(<span class="stringliteral">"histy"</span>, <span class="stringliteral">"Residual VS angle (Y)"</span>, 
00061                        256, 0.5, 256.5, 20, -1, 1, 100, -1, 1));
00062   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH3F(<span class="stringliteral">"hists"</span>, <span class="stringliteral">"Residual (X) VS Sensor"</span>, 
00063                        256, 0.5, 256.5, 15, 0, 15, 100, -1, 1));
00064   <a class="code" href="classAlignObject.html#s0">sharray</a>.Add(<span class="keyword">new</span> TH3F(<span class="stringliteral">"histp"</span>, <span class="stringliteral">"Residual (Y) VS Sensor"</span>, 
00065                        256, 0.5, 256.5, 15, 0, 15, 100, -1, 1));
00066 }
00067 
<a name="l00068"></a><a class="code" href="classAlignObject.html#a4">00068</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#a4">AlignObject::InitHists</a>(TDirectory *dir)
00069 {
00070   <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#p1">harray</a>.GetEntries() &gt; 0) {
00071     Int_t nh = <a class="code" href="classAlignObject.html#p1">harray</a>.GetEntries();
00072     <span class="keywordflow">for</span> (Int_t i = 0; i &lt; nh; i++)
00073       ((TH1 *)<a class="code" href="classAlignObject.html#p1">harray</a>.At(i))-&gt;Reset();
00074     <span class="keywordflow">return</span>;
00075   }
00076 
00077   <a class="code" href="classAlignObject.html#p2">ldir</a> = dir;
00078   <a class="code" href="classAlignObject.html#p2">ldir</a>-&gt;cd();
00079 
00080   Int_t slot = TMath::Abs(<a class="code" href="classAlignObject.html#p0">tkid</a>)%100;
00081   Int_t sign = (<a class="code" href="classAlignObject.html#p0">tkid</a> &lt; 0) ? -1 : 1;
00082   <a class="code" href="classAlignObject.html#p3">cdir</a> = <span class="keyword">new</span> TDirectory(Form(<span class="stringliteral">"dir%c%02d"</span>, (sign &gt; 0) ? <span class="charliteral">'p'</span> : <span class="charliteral">'n'</span>, slot),
00083                         Form(<span class="stringliteral">"TkId %d"</span>, <a class="code" href="classAlignObject.html#p0">tkid</a>));
00084   <a class="code" href="classAlignObject.html#p3">cdir</a>-&gt;cd();
00085 
00086   <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH2F(<span class="stringliteral">"hist001"</span>, <span class="stringliteral">"dX VS X"</span>,     30, -60, 60, 100, -1, 1));
00087   <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH2F(<span class="stringliteral">"hist002"</span>, <span class="stringliteral">"dY VS X"</span>,     30, -60, 60, 100, -1, 1));
00088   <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH2F(<span class="stringliteral">"hist003"</span>, <span class="stringliteral">"dX VS dX/dZ"</span>, 20,  -1,  1, 100, -1, 1));
00089   <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH2F(<span class="stringliteral">"hist004"</span>, <span class="stringliteral">"dY VS dY/dZ"</span>, 20,  -1,  1, 100, -1, 1));
00090   <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist005"</span>, <span class="stringliteral">"dZ(X) VS X"</span>,  30, -60, 60));
00091   <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH1F(<span class="stringliteral">"hist006"</span>, <span class="stringliteral">"dZ(Y) VS X"</span>,  30, -60, 60));
00092 
00093   TH2F *hist1 = (TH2F *)<a class="code" href="classAlignObject.html#p1">harray</a>.At(0);
00094   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; 30; i++) {
00095     Double_t x1 = hist1-&gt;GetXaxis()-&gt;GetBinLowEdge(i+1);
00096     Double_t x2 = hist1-&gt;GetXaxis()-&gt;GetBinLowEdge(i+2);
00097     <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH2F(Form(<span class="stringliteral">"hist%02d1"</span>, i+1), 
00098                         Form(<span class="stringliteral">"dX VS dX/dZ (%.0f&lt;X&lt;%.0f)"</span>, x1, x2), 
00099                         20, -1, 1, 100, -1, 1));
00100     <a class="code" href="classAlignObject.html#p1">harray</a>.Add(<span class="keyword">new</span> TH2F(Form(<span class="stringliteral">"hist%02d2"</span>, i+1), 
00101                         Form(<span class="stringliteral">"dY VS dX/dZ (%.0f&lt;X&lt;%.0f)"</span>, x1, x2), 
00102                         20, -1, 1, 100, -1, 1));
00103   }
00104 }
00105 
<a name="l00106"></a><a class="code" href="classAlignObject.html#a5">00106</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#a5">AlignObject::ResetHists</a>(<span class="keywordtype">void</span>)
00107 {
00108   Int_t nh = <a class="code" href="classAlignObject.html#p1">harray</a>.GetEntries();
00109   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; nh; i++)
00110     ((TH1 *)<a class="code" href="classAlignObject.html#p1">harray</a>.At(i))-&gt;Reset();
00111 }
00112 
<a name="l00113"></a><a class="code" href="classAlignObject.html#a6">00113</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#a6">AlignObject::FillHist</a>(Int_t i, Double_t x, Double_t y)
00114 {
00115   TH2F *hist = (TH2F*)<a class="code" href="classAlignObject.html#p1">harray</a>.At(i);
00116   <span class="keywordflow">if</span> (hist) hist-&gt;Fill(x, y);
00117 }
00118 
<a name="l00119"></a><a class="code" href="classAlignObject.html#a7">00119</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#a7">AlignObject::ProcHists</a>(Int_t bits)
00120 {
00121   <a class="code" href="classAlignObject.html#p3">cdir</a>-&gt;cd();
00122 
00123   Double_t par[6], per[6];
00124   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; 6; i++) par[i] = per[i] = 0;
00125 
00126   TH1F *hdzx = (TH1F *)<a class="code" href="classAlignObject.html#p1">harray</a>.At(4);
00127   TH1F *hdzy = (TH1F *)<a class="code" href="classAlignObject.html#p1">harray</a>.At(5);
00128   Int_t nfit = 0;
00129 
00130   Int_t nh = <a class="code" href="classAlignObject.html#p1">harray</a>.GetEntries();
00131   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; nh; i++) {
00132     <span class="keywordflow">if</span> (i == 4 || i == 5) <span class="keywordflow">continue</span>;
00133 
00134     TH2F *hist = (TH2F *)<a class="code" href="classAlignObject.html#p1">harray</a>.At(i);
00135     <span class="keywordflow">if</span> (hist-&gt;GetSumOfWeights() &lt; 100) <span class="keywordflow">continue</span>;
00136 
00137     TH1D *prof = <a class="code" href="classAlignObject.html#e1">Profile</a>(hist);
00138     Int_t npt = 0;
00139     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; prof-&gt;GetNbinsX(); j++)
00140       <span class="keywordflow">if</span> (prof-&gt;GetBinError(j+1) &gt; 0) npt++;
00141     <span class="keywordflow">if</span> (npt &lt; 2) <span class="keywordflow">continue</span>;
00142 
00143     prof-&gt;Fit(<span class="stringliteral">"pol1"</span>, <span class="stringliteral">"q0"</span>);
00144     TF1 *func = prof-&gt;GetFunction(<span class="stringliteral">"pol1"</span>);
00145 
00146     <span class="keywordflow">if</span> (i == 0) {
00147       <span class="keywordflow">if</span> (bits &amp; XYcorr1) {
00148         par[0] = -func-&gt;GetParameter(0);
00149         per[0] =  func-&gt;GetParError (0);
00150       }
00151       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits &amp; XYcorr3)
00152         <a class="code" href="classAlignObject.html#a8">SigmaProj</a>(hist, par[0], per[0]);
00153 
00154       par[5] = func-&gt;GetParameter(1);
00155       per[5] = func-&gt;GetParError (1);
00156     }
00157 
00158     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 1) {
00159       <span class="keywordflow">if</span> (bits &amp; XYcorr1) {
00160         par[1] = -func-&gt;Eval(<a class="code" href="classAlignObject.html#o0">cool</a>[0]);
00161         per[1] =  func-&gt;GetParError (0);
00162       }
00163       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits &amp; XYcorr3)
00164         <a class="code" href="classAlignObject.html#a8">SigmaProj</a>(hist, par[1], per[1]);
00165 
00166       <span class="keywordflow">if</span> (bits &amp; dYXcorr) {
00167         par[3] = -func-&gt;GetParameter(1);
00168         per[3] =  func-&gt;GetParError (1);
00169       }
00170     }
00171 
00172     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 2) {
00173       <span class="keywordflow">if</span> (bits &amp; XYcorr2) {
00174         par[0] = -func-&gt;GetParameter(0);
00175         per[0] =  func-&gt;GetParError (0);
00176       }
00177       <span class="keywordflow">if</span> (bits &amp; Zcorr1) {
00178         par[2] = func-&gt;GetParameter(1);
00179         per[2] = func-&gt;GetParError (1);
00180       }
00181     }
00182 
00183     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 3) {
00184       <span class="keywordflow">if</span> (bits &amp; XYcorr2) {
00185         par[1] = -func-&gt;GetParameter(0);
00186         per[1] =  func-&gt;GetParError (0);
00187       }
00188       <span class="keywordflow">if</span> (bits &amp; Zcorr2) {
00189         par[2] = func-&gt;GetParameter(1);
00190         per[2] = func-&gt;GetParError (1);
00191       }
00192     }
00193 
00194     <span class="keywordflow">else</span> {
00195       TH1F *hdz = (i%2 == 0) ? hdzx : hdzy;
00196       hdz-&gt;SetBinContent((i-6)/2+1, func-&gt;GetParameter(1));
00197       hdz-&gt;SetBinError  ((i-6)/2+1, func-&gt;GetParError (1));
00198       <span class="keywordflow">if</span> (i%2 == 1) nfit++;
00199     }
00200   }
00201 
00202   <span class="keywordflow">if</span> (nfit &gt; 2 &amp;&amp; (bits &amp; dZXcorr)) {
00203     hdzy-&gt;Fit(<span class="stringliteral">"pol1"</span>, <span class="stringliteral">"q0"</span>);
00204     TF1 *func2 = hdzy-&gt;GetFunction(<span class="stringliteral">"pol1"</span>);
00205     par[4] = -func2-&gt;GetParameter(1);
00206     per[4] =  func2-&gt;GetParError (1);
00207     par[2] =  func2-&gt;Eval(<a class="code" href="classAlignObject.html#o0">cool</a>[0]);
00208     per[2] =  func2-&gt;GetParError(0);
00209   }
00210 
00211   Int_t ly = TMath::Abs(<a class="code" href="classAlignObject.html#p0">tkid</a>)/100;
00212   Int_t sl = <a class="code" href="classAlignObject.html#p0">tkid</a>%100;
00213   Int_t <span class="keywordtype">id</span> = (ly-1)*32+sl+16-((<a class="code" href="classAlignObject.html#p0">tkid</a> &gt; 0) ? 1 : 0);
00214 
00215   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; 6; i++) {
00216     Double_t factor = (i &gt;= 3) ? 600 : 1;
00217     TH1F *hist = (TH1F *)<a class="code" href="classAlignObject.html#s0">sharray</a>.At(i);
00218     hist-&gt;SetBinContent(<span class="keywordtype">id</span>, par[i]*factor);
00219     hist-&gt;SetBinError  (<span class="keywordtype">id</span>, per[i]*factor);
00220 
00221     <span class="keywordflow">if</span> (i &lt; 3 &amp;&amp; <a class="code" href="classAlignObject.html#o1">fixp</a>[i] == 1) <a class="code" href="classAlignObject.html#o2">param</a>[i] += par[i]*0.1;
00222   }
00223   <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#o1">fixp</a>[4] == 1) <a class="code" href="classAlignObject.html#o4">phi</a>   += par[3]*0.1;
00224   <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#o1">fixp</a>[3] == 1) <a class="code" href="classAlignObject.html#o6">pitch</a> += par[4]*0.1;
00225   <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#o1">fixp</a>[5] == 1) <a class="code" href="classAlignObject.html#o8">roll</a>  += par[5]*0.1;
00226 }
00227 
<a name="l00228"></a><a class="code" href="classAlignObject.html#a8">00228</a> <span class="keywordtype">void</span> <a class="code" href="classAlignObject.html#a8">AlignObject::SigmaProj</a>(TH2 *hist, Double_t &amp;par, Double_t &amp;err)
00229 {
00230   par = err = 0;
00231 
00232   TH1D *hprj = hist-&gt;ProjectionY(<span class="stringliteral">"hprj"</span>);
00233 
00234   Double_t nmin = 100;
00235 
00236   <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#s1">ProfMode</a> == 1) {
00237     Int_t nx = hprj-&gt;GetNbinsX();
00238 
00239     Double_t *hx = <span class="keyword">new</span> Double_t[nx];
00240     Double_t *hy = <span class="keyword">new</span> Double_t[nx];
00241     Double_t *hw = <span class="keyword">new</span> Double_t[nx];
00242 
00243     Int_t neff = 0;
00244     Double_t sum = 0;
00245     <span class="keywordflow">for</span> (Int_t i = 0; i &lt; nx; i++) {
00246       Double_t c = hprj-&gt;GetBinContent(i+1);
00247       hx[i] = hprj-&gt;GetBinCenter(i+1);
00248       hy[i] = hw[i] = 0;
00249 
00250       <span class="keywordflow">if</span> (c &gt; 10) {
00251         Double_t lc =  TMath::Log(c);
00252         Double_t er = (TMath::Log(c+TMath::Sqrt(c))-lc)/c;
00253         hy[i] = lc;
00254         hw[i] = 1/er/er;
00255         sum += c;
00256         neff++;
00257       }
00258     }
00259 
00260     <span class="keywordflow">if</span> (sum &gt; nmin &amp;&amp; neff &gt; 3) {
00261       Double_t pp[3];
00262       <a class="code" href="classAlignObject.html#e2">Fit2D</a>(nx, hy, hx, hw, pp);
00263 
00264       <span class="keywordflow">if</span> (pp[2] &lt; 0) {
00265         Double_t gpar1 = -pp[1]/pp[2]/2;
00266         Double_t gpar2 = TMath::Sqrt(-0.5/pp[2]);
00267         Double_t gerr1 = gpar2/TMath::Sqrt(sum);
00268         par = -gpar1;
00269         err =  gerr1;
00270       }
00271     }
00272 
00273     <span class="keyword">delete</span> [] hx;
00274     <span class="keyword">delete</span> [] hy;
00275     <span class="keyword">delete</span> [] hw;
00276   }
00277 
00278   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#s1">ProfMode</a> == 2) {
00279     <span class="keywordflow">if</span> (hprj-&gt;GetSumOfWeights() &gt; nmin) {
00280       hprj-&gt;Fit(<span class="stringliteral">"gaus"</span>, <span class="stringliteral">"q0"</span>);
00281       TF1 *func = hprj-&gt;GetFunction(<span class="stringliteral">"gaus"</span>);
00282       par = -func-&gt;GetParameter(1);
00283       err =  func-&gt;GetParError (1);
00284     }
00285   }
00286 
00287   <span class="keyword">delete</span> hprj;
00288 }
00289 
<a name="l00290"></a><a class="code" href="classAlignObject.html#e1">00290</a> TH1D *<a class="code" href="classAlignObject.html#e1">AlignObject::Profile</a>(TH2 *hist)
00291 {
00292   TString hname = hist-&gt;GetName();
00293   hname.ReplaceAll(<span class="stringliteral">"hist"</span>, <span class="stringliteral">"prof"</span>);
00294   <span class="keywordflow">if</span> (hname == <span class="stringliteral">"hist"</span>) hname += <span class="stringliteral">"_pf"</span>;
00295 
00296   TH1D *prof = hist-&gt;ProjectionX(hname);
00297   TH1D *htmp = 0;
00298   Int_t nmin = 50;
00299 
00300   prof-&gt;Reset();
00301 
00302   Int_t nx = hist-&gt;GetNbinsX();
00303   Int_t ny = hist-&gt;GetNbinsY();
00304 
00305   Double_t *hx = <span class="keyword">new</span> Double_t[ny];
00306   Double_t *hy = <span class="keyword">new</span> Double_t[ny];
00307   Double_t *hw = <span class="keyword">new</span> Double_t[ny];
00308 
00309   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; nx; i++) {
00310     Int_t neff = 0;
00311     Double_t sum = 0;
00312     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; ny; j++) {
00313       hx[j] = hist-&gt;GetYaxis()-&gt;GetBinCenter(j+1);
00314       hy[j] = hw[j] = 0;
00315 
00316       Double_t c = hist-&gt;GetBinContent(i+1, j+1);
00317       sum += c;
00318 
00319       <span class="keywordflow">if</span> (c &gt; 10) {
00320         Double_t lc =  TMath::Log(c);
00321         Double_t er = (TMath::Log(c+TMath::Sqrt(c))-lc)/c;
00322         hy[j] = lc;
00323         hw[j] = 1/er/er;
00324         neff++;
00325       }
00326     }
00327 
00328     Double_t par = 0, per = 0;
00329     <span class="keywordflow">if</span> (sum &gt; nmin &amp;&amp; neff &gt; 3) {
00330 
00331       <span class="comment">// Fast gaussian fit</span>
00332       <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#s1">ProfMode</a> == 1) {
00333         Double_t pp[3];
00334         <a class="code" href="classAlignObject.html#e2">Fit2D</a>(ny, hy, hx, hw, pp);
00335 
00336         <span class="keywordflow">if</span> (pp[2] &lt; 0) {
00337           Double_t gpar1 = -pp[1]/pp[2]/2;
00338           Double_t gpar2 = TMath::Sqrt(-0.5/pp[2]);
00339           Double_t gerr1 = gpar2/TMath::Sqrt(sum);
00340           par = gpar1;
00341           per = gerr1;
00342         }
00343       }
00344 
00345       <span class="comment">// Normal fit (slow and memory consumption)</span>
00346       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#s1">ProfMode</a> == 2) {
00347         htmp = hist-&gt;ProjectionY(<span class="stringliteral">"htmp"</span>, i+1, i+1);
00348         htmp-&gt;Fit(<span class="stringliteral">"gaus"</span>, <span class="stringliteral">"q0"</span>);
00349         TF1 *func = htmp-&gt;GetFunction(<span class="stringliteral">"gaus"</span>);
00350         par = func-&gt;GetParameter(1);
00351         per = func-&gt;GetParError (1);
00352       }
00353     }
00354 
00355     <span class="keywordflow">if</span> (sum &gt; nmin/10 &amp;&amp; par == 0 &amp;&amp; per == 0) {
00356       htmp = hist-&gt;ProjectionY(<span class="stringliteral">"htmp"</span>, i+1, i+1);
00357       <span class="comment">// Simple mean</span>
00358       <span class="keywordflow">if</span> (htmp-&gt;GetMeanError() &gt; 1e-4) {
00359         par = htmp-&gt;GetMean();
00360         per = htmp-&gt;GetMeanError();
00361       }
00362     }
00363 
00364     prof-&gt;SetBinContent(i+1, par);
00365     prof-&gt;SetBinError  (i+1, per);
00366   }
00367   prof-&gt;SetEntries(hist-&gt;GetSumOfWeights());
00368 
00369   <span class="keyword">delete</span> htmp;
00370 
00371   <span class="keyword">delete</span> [] hx;
00372   <span class="keyword">delete</span> [] hy;
00373   <span class="keyword">delete</span> [] hw;
00374 
00375   <span class="keywordflow">return</span> prof;
00376 }
00377 
<a name="l00378"></a><a class="code" href="classAlignObject.html#e2">00378</a> Int_t <a class="code" href="classAlignObject.html#e2">AlignObject::Fit2D</a>(Int_t n, Double_t *x, Double_t *y, 
00379                                   Double_t *w, Double_t *par)
00380 {
00381   <span class="comment">// Analytic parabola fitting method</span>
00382 
00383   <span class="comment">// check number of hits</span>
00384   <span class="keywordflow">if</span> (n &lt; 4) <span class="keywordflow">return</span> -1;
00385 
00386   Int_t np = 3;
00387 
00388   Double_t mtx[3][3], vec[3];
00389   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; 9; i++) mtx[i/3][i%3] = vec[i/3] = 0;
00390 
00391   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; n; i++) {
00392     Double_t m0 = (w) ? w[i] : 1;
00393     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; np; j++) {
00394       Double_t m = m0;
00395       <span class="keywordflow">for</span> (Int_t k = j; k &lt; np; k++) {
00396         mtx[j][k] += m;
00397         <span class="keywordflow">if</span> (j == 0) vec[k] += m*x[i];
00398         m *= y[i];
00399       }
00400       m0 *= y[i]*y[i];
00401     }
00402   }
00403   mtx[1][0] = mtx[0][1];
00404   mtx[2][0] = mtx[0][2];
00405   mtx[2][1] = mtx[1][2];
00406 
00407   <span class="keywordflow">if</span> (<a class="code" href="classAlignObject.html#e3">Inv3x3</a>(mtx) &lt; 0) <span class="keywordflow">return</span> -1;
00408 
00409   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; np; i++)
00410     par[i] = mtx[i][0]*vec[0]+mtx[i][1]*vec[1]+mtx[i][2]*vec[2];
00411   <span class="keywordflow">return</span> 0;
00412 }
00413 
<a name="l00414"></a><a class="code" href="classAlignObject.html#e3">00414</a> Int_t <a class="code" href="classAlignObject.html#e3">AlignObject::Inv3x3</a>(Double_t mtx[3][3])
00415 {
00416   Double_t pM[9];
00417   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; 9; i++) pM[i] = mtx[i/3][i%3];
00418 
00419   <span class="keyword">const</span> Double_t c00 = pM[4] * pM[8] - pM[5] * pM[7];
00420   <span class="keyword">const</span> Double_t c01 = pM[5] * pM[6] - pM[3] * pM[8];
00421   <span class="keyword">const</span> Double_t c02 = pM[3] * pM[7] - pM[4] * pM[6];
00422   <span class="keyword">const</span> Double_t c10 = pM[7] * pM[2] - pM[8] * pM[1];
00423   <span class="keyword">const</span> Double_t c11 = pM[8] * pM[0] - pM[6] * pM[2];
00424   <span class="keyword">const</span> Double_t c12 = pM[6] * pM[1] - pM[7] * pM[0];
00425   <span class="keyword">const</span> Double_t c20 = pM[1] * pM[5] - pM[2] * pM[4];
00426   <span class="keyword">const</span> Double_t c21 = pM[2] * pM[3] - pM[0] * pM[5];
00427   <span class="keyword">const</span> Double_t c22 = pM[0] * pM[4] - pM[1] * pM[3];
00428 
00429   <span class="keyword">const</span> Double_t t0 = TMath::Abs(pM[0]);
00430   <span class="keyword">const</span> Double_t t1 = TMath::Abs(pM[3]);
00431   <span class="keyword">const</span> Double_t t2 = TMath::Abs(pM[6]);
00432   Double_t det;
00433   Double_t tmp;
00434   <span class="keywordflow">if</span> (t0 &gt;= t1) {
00435     <span class="keywordflow">if</span> (t2 &gt;= t0) {
00436     tmp = pM[6];
00437     det = c12*c01-c11*c02;
00438     } <span class="keywordflow">else</span> {
00439       tmp = pM[0];
00440       det = c11*c22-c12*c21;
00441     }
00442   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t2 &gt;= t1) {
00443     tmp = pM[6];
00444     det = c12*c01-c11*c02;
00445   } <span class="keywordflow">else</span> {
00446     tmp = pM[3];
00447     det = c02*c21-c01*c22;
00448   }
00449 
00450   <span class="keywordflow">if</span> ( det == 0 || tmp == 0) {
00451     std::cout &lt;&lt; <span class="stringliteral">"Inv3x3 matrix is singular"</span> &lt;&lt; std::endl;
00452     <span class="keywordflow">return</span> -1;
00453   }
00454 
00455   <span class="keyword">const</span> Double_t s = tmp/det;
00456 
00457   pM[0] = s*c00;
00458   pM[1] = s*c10;
00459   pM[2] = s*c20;
00460   pM[3] = s*c01;
00461   pM[4] = s*c11;
00462   pM[5] = s*c21;
00463   pM[6] = s*c02;
00464   pM[7] = s*c12;
00465   pM[8] = s*c22;
00466 
00467   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; 9; i++) mtx[i/3][i%3] = pM[i];
00468 
00469   <span class="keywordflow">return</span> 0;
00470 }
00471 
<a name="l00472"></a><a class="code" href="AlignFit_8C.html#a0">00472</a> <a class="code" href="TrTrack_8C.html#a0">ClassImp</a>(<a class="code" href="classAlignFit.html">AlignFit</a>)
00473 
00474 TString <a class="code" href="classAlignFit.html">AlignFit</a>::ofname = "alignfit.root";
00475 
00476 <a class="code" href="classAlignFit.html">AlignFit</a>::<a class="code" href="classAlignFit.html">AlignFit</a>(<span class="keywordtype">void</span>)
00477 {
00478   fArray = <span class="keyword">new</span> Float_t[Nbuf];
00479   fCrray = <span class="keyword">new</span> <span class="keywordtype">char</span>[Ncbf];
00480   Init();
00481 
00482   fSigma[0] = 500e-4;
00483   fSigma[1] = 200e-4;
00484 
00485   ofile = 0;
00486 }
00487 
<a name="l00488"></a><a class="code" href="classAlignFit.html#a1">00488</a> <a class="code" href="classAlignFit.html#a1">AlignFit::~AlignFit</a>()
00489 {
00490   <span class="keywordflow">if</span> (ofile) {
00491     <a class="code" href="classAlignFit.html#p6">ofile</a>-&gt;Write();
00492     <span class="keyword">delete</span> ofile;
00493   }
00494 
00495   <span class="keyword">delete</span> [] fArray;
00496   <span class="keyword">delete</span> [] fCrray;
00497 }
00498 
<a name="l00499"></a><a class="code" href="classAlignFit.html#a9">00499</a> <span class="keywordtype">void</span> <a class="code" href="classAlignFit.html#a9">AlignFit::Init</a>(<span class="keywordtype">void</span>)
00500 {
00501   <a class="code" href="classAlignFit.html#p0">fNcases</a> = 0;
00502   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nchi2; i++) 
00503     <a class="code" href="classAlignFit.html#p1">fXchi2</a>[i][0] = <a class="code" href="classAlignFit.html#p1">fXchi2</a>[i][1] = 0;
00504 
00505   <a class="code" href="classAlignFit.html#p6">ofile</a> = 0;
00506 }
00507 
00508 <span class="keywordtype">void</span> <a class="code" href="classAlignFit.html#a10">AlignFit::SetHits</a>(Float_t arr[Ndim][Nplan], Int_t prm[Ndim][Nplan])
00509 {
00510   <span class="keywordflow">if</span> (fNcases &gt;= MaxCases) <span class="keywordflow">return</span>;
00511 
00512   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nplan; i++) {
00513 
00514     <span class="keywordflow">if</span> (arr[3][i] == 0) {
00515       <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Narr; j++)
00516         <a class="code" href="classAlignFit.html#a4">SetArray</a>(fNcases, i, j, 0);
00517       <a class="code" href="classAlignFit.html#a7">SetCrray</a>(fNcases, i, 0);
00518       <span class="keywordflow">continue</span>;
00519     }
00520 
00521     Int_t slot = (Int_t)arr[3][i];
00522     Int_t sign = (arr[4][i] == 1) ? -1 : 1;
00523     Int_t tkid = sign*((i+1)*100+slot);
00524     <a class="code" href="classAlignFit.html#a7">SetCrray</a>(fNcases, i, slot*sign);
00525 
00526     <a class="code" href="classAlignObject.html">AlignObject</a> *obj = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00527     <span class="keywordflow">if</span> (!obj) {
00528       obj = <span class="keyword">new</span> <a class="code" href="classAlignObject.html">AlignObject</a>(tkid);
00529       <a class="code" href="classAlignFit.html#p5">aligmap</a>[tkid] = obj;
00530     }
00531 
00532     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; 6; j++) {
00533       <span class="keywordflow">if</span> (j &lt; Narr) <a class="code" href="classAlignFit.html#a4">SetArray</a>(fNcases, i, j, arr[j][i]);
00534       <span class="keywordflow">if</span> (j &lt; 3) obj-&gt;<a class="code" href="classAlignObject.html#o0">cool</a>[j] = arr[7+j][i];
00535       <span class="keywordflow">if</span> (j &lt; 6) obj-&gt;<a class="code" href="classAlignObject.html#o1">fixp</a>[j] = prm[j][i];
00536     }
00537   }
00538   <a class="code" href="classAlignFit.html#p0">fNcases</a>++;
00539 }
00540 
<a name="l00541"></a><a class="code" href="classAlignFit.html#a11">00541</a> <span class="keywordtype">void</span> <a class="code" href="classAlignFit.html#a11">AlignFit::Fit</a>(Float_t chi2m, Int_t algo, Float_t xf[2], 
00542                   Float_t rigmin, Int_t itermin)
00543 {
00544   std::cout &lt;&lt; <span class="stringliteral">" fNcases "</span> &lt;&lt; <a class="code" href="classAlignFit.html#p0">fNcases</a> &lt;&lt; std::endl;
00545 
00546   TStopwatch timer;
00547   timer.Start();
00548   Float_t ptime = 0;
00549 
00550   Double_t chi2max = chi2m;
00551   Double_t rmax = 0.1;
00552   Int_t iter = 0, miter = 20;
00553   Double_t chi2o = 10000000;
00554 
00555   <span class="keywordflow">if</span> (!ofile) <a class="code" href="classAlignFit.html#p6">ofile</a> = <span class="keyword">new</span> TFile(<a class="code" href="classAlignFit.html#s0">ofname</a>, <span class="stringliteral">"recreate"</span>);
00556 
00557   <span class="keywordflow">for</span> (<a class="code" href="AlignFit_8h.html#a0">aligIT</a> it = <a class="code" href="classAlignFit.html#p5">aligmap</a>.begin(); it != <a class="code" href="classAlignFit.html#p5">aligmap</a>.end(); it++) {
00558     <a class="code" href="classAlignObject.html">AlignObject</a> *algp = it-&gt;second;
00559     <span class="keywordflow">if</span> (algp) algp-&gt;<a class="code" href="classAlignObject.html#a3">Reset</a>();
00560   }
00561 
00562   gROOT-&gt;cd();
00563   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nplan; i++) {
00564     TDirectory *ldir 
00565       = <span class="keyword">new</span> TDirectory(Form(<span class="stringliteral">"dir%d"</span>, i+1), Form(<span class="stringliteral">"Layer %d"</span>, i+1));
00566 
00567     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Nlad; j++) {
00568       <span class="keywordflow">for</span> (Int_t k = 0; k &lt; Nhalf; k++) {
00569         Int_t slot = j+1;
00570         Int_t sign = (k == 0) ? -1 : 1;
00571         Int_t tkid = sign*((i+1)*100+slot);
00572         <a class="code" href="classAlignObject.html">AlignObject</a> *algp = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00573         <span class="keywordflow">if</span> (!algp) <span class="keywordflow">continue</span>;
00574 
00575         algp-&gt;<a class="code" href="classAlignObject.html#a4">InitHists</a>(ldir);
00576       }
00577     }
00578   }
00579 
00580  <span class="keywordflow">for</span> (iter = 0; iter &lt;= miter; iter++) {
00581 
00582   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nplan; i++) {
00583     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Nlad; j++) {
00584       <span class="keywordflow">for</span> (Int_t k = 0; k &lt; Nhalf; k++) {
00585         Int_t slot = j+1;
00586         Int_t sign = (k == 0) ? -1 : 1;
00587         Int_t tkid = sign*((i+1)*100+slot);
00588         <a class="code" href="classAlignObject.html">AlignObject</a> *algp = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00589         <span class="keywordflow">if</span> (!algp) <span class="keywordflow">continue</span>;
00590 
00591         algp-&gt;<a class="code" href="classAlignObject.html#a5">ResetHists</a>();
00592       }
00593     }
00594   }
00595 
00596   <a class="code" href="classAlignFit.html#p6">ofile</a>-&gt;cd();
00597   TDirectory *dir = <span class="keyword">new</span> TDirectory(Form(<span class="stringliteral">"iter%d"</span>, iter), 
00598                                    Form(<span class="stringliteral">"Iteration %d"</span>, iter));
00599   dir-&gt;cd();
00600   <a class="code" href="classAlignObject.html#e0">AlignObject::InitSHists</a>();
00601 
00602 
00603   Double_t chi2a = 0, chi2;
00604   Int_t ntot = 0;
00605 
00606   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; fNcases; i++) {
00607     Float_t res[Nplan][2];
00608     Double_t ch[2];
00609 
00610     <span class="keywordflow">for</span> (Int_t l = 0; l &lt; 2; l++) {
00611       Double_t x = 0, y = 0, x2 = 0, y2 = 0, nx = 0, xy = 0;
00612       Double_t dy[Nplan];
00613       Float_t z[Nplan];
00614       <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Nplan; j++) {
00615         Int_t slot = <a class="code" href="classAlignFit.html#a6">GetCrray</a>(i, j);
00616         <span class="keywordflow">if</span> (slot == 0) <span class="keywordflow">continue</span>;
00617 
00618         Int_t sign = TMath::Sign(1, slot);
00619         Int_t tkid = sign*((j+1)*100+TMath::Abs(slot));
00620 
00621         <a class="code" href="classAlignObject.html">AlignObject</a> *algp = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00622         <span class="keywordflow">if</span> (!algp) {
00623           std::cout &lt;&lt; <span class="stringliteral">"WARNING algp not found: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00624           <span class="keywordflow">continue</span>;
00625         }
00626 
00627         Double_t sy = TMath::Sin(algp-&gt;<a class="code" href="classAlignObject.html#o4">phi</a>);
00628         Double_t cy = TMath::Cos(algp-&gt;<a class="code" href="classAlignObject.html#o4">phi</a>);
00629         Double_t sp = TMath::Sin(algp-&gt;<a class="code" href="classAlignObject.html#o6">pitch</a>);
00630         Double_t cp = TMath::Cos(algp-&gt;<a class="code" href="classAlignObject.html#o6">pitch</a>);
00631         Double_t sr = TMath::Sin(algp-&gt;<a class="code" href="classAlignObject.html#o8">roll</a>);
00632         Double_t cr = TMath::Cos(algp-&gt;<a class="code" href="classAlignObject.html#o8">roll</a>);
00633         Double_t mtx[3][3];
00634         mtx[0][0]=cy*cp;
00635         mtx[1][0]=-sy;
00636         mtx[2][0]=cy*sp;
00637         mtx[0][1]=cr*sy*cp-sr*sp;
00638         mtx[1][1]=cr*cy;
00639         mtx[2][1]=cr*sy*sp+sr*cp;
00640         mtx[0][2]=-sr*sy*cp-cr*sp;
00641         mtx[1][2]=-sr*cy;
00642         mtx[2][2]=-sr*sy*sp+cr*cp;
00643 
00644         Double_t d[2];
00645         Double_t s1 = <a class="code" href="classAlignFit.html#a3">GetArray</a>(i,j,0)-algp-&gt;<a class="code" href="classAlignObject.html#o0">cool</a>[0];
00646         Double_t s2 = <a class="code" href="classAlignFit.html#a3">GetArray</a>(i,j,1)-algp-&gt;<a class="code" href="classAlignObject.html#o0">cool</a>[1];
00647         Double_t d3 = mtx[0][2]*s1+mtx[1][2]*s2;
00648         Double_t s3 = <a class="code" href="classAlignFit.html#a3">GetArray</a>(i,j,2)-algp-&gt;<a class="code" href="classAlignObject.html#o0">cool</a>[2]+d3;
00649         d [0] = mtx[0][0]*s1+mtx[1][0]*s2+mtx[2][0]*s3;
00650         d [1] = mtx[0][1]*s1+mtx[1][1]*s2+mtx[2][1]*s3;
00651         z [j] = <a class="code" href="classAlignFit.html#a3">GetArray</a>(i,j,2)+algp-&gt;<a class="code" href="classAlignObject.html#o2">param</a>[2]+d3;
00652         dy[j] = d[l]+algp-&gt;<a class="code" href="classAlignObject.html#o0">cool</a>[l]+algp-&gt;<a class="code" href="classAlignObject.html#o2">param</a>[l];
00653 
00654         y  = y +dy[j];
00655         xy = xy+dy[j]*z [j];
00656         y2 = y2+dy[j]*dy[j];
00657         x  = x +z [j];
00658         x2 = x2+z [j]*z [j];
00659         nx = nx+1;
00660       }
00661 
00662       <span class="keywordflow">if</span> (nx &gt; Nplan-3) {
00663         chi2 = 0;
00664         x  =  x/nx;
00665         y  =  y/nx;
00666         xy = xy/nx;
00667         x2 = x2/nx;
00668         y2 = y2/nx;
00669         x2 = (x2-x*x);
00670         Double_t a = (xy-x*y)/x2;
00671         Double_t b = y-a*x;
00672 
00673         <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Nplan; j++) {
00674           res[j][l] = dy[j]-b-a*z[j];
00675           <span class="keywordflow">if</span> (<a class="code" href="classAlignFit.html#a6">GetCrray</a>(i, j) != 0)
00676             chi2 += res[j][l]*res[j][l]/<a class="code" href="classAlignFit.html#p4">fSigma</a>[l]/<a class="code" href="classAlignFit.html#p4">fSigma</a>[l];
00677         }
00678         ch[l] = chi2;
00679 
00680         <span class="keywordflow">if</span> (l == 1 &amp;&amp; i &lt; Nchi2) {
00681           <span class="keywordflow">if</span> (iter == 0) <a class="code" href="classAlignFit.html#p1">fXchi2</a>[i][0] = ch[0]+ch[1];
00682           <a class="code" href="classAlignFit.html#p1">fXchi2</a>[i][1] = ch[0]+ch[1];
00683         }
00684         <span class="keywordflow">if</span> ((chi2 &lt; chi2max) || iter &lt; itermin) {
00685           <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Nplan; j++) {
00686             Int_t slot = <a class="code" href="classAlignFit.html#a6">GetCrray</a>(i, j);
00687             <span class="keywordflow">if</span> (slot == 0) <span class="keywordflow">continue</span>;
00688 
00689             Int_t sign = TMath::Sign(1, slot);
00690             Int_t tkid = sign*((j+1)*100+TMath::Abs(slot));
00691 
00692             <a class="code" href="classAlignObject.html">AlignObject</a> *algp = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00693             <span class="keywordflow">if</span> (!algp) {
00694               std::cout &lt;&lt; <span class="stringliteral">"WARNING algp not found: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00695               <span class="keywordflow">continue</span>;
00696             }
00697             <span class="keywordflow">if</span> (TMath::Abs(res[j][l]) &lt; rmax) {
00698               Double_t xh = <a class="code" href="classAlignFit.html#a3">GetArray</a>(i, j, 0);
00699               Int_t m = (Int_t)((xh+60)/60*15);
00700               <span class="keywordflow">if</span> (0 &lt;= m &amp;&amp; m &lt; 30) {
00701                 algp-&gt;<a class="code" href="classAlignObject.html#a6">FillHist</a>(l,        xh, res[j][l]*10);
00702                 algp-&gt;<a class="code" href="classAlignObject.html#a6">FillHist</a>(l+2,       a, res[j][l]*10);
00703                 algp-&gt;<a class="code" href="classAlignObject.html#a6">FillHist</a>(l+(m+3)*2, a, res[j][l]*10);
00704               }
00705 
00706               <a class="code" href="classTkLadder.html">TkLadder</a> *lad = TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#a22">FindTkId</a>(tkid);
00707               Int_t <span class="keywordtype">id</span> = j*32+slot+16-((tkid &gt; 0) ? 1 : 0);
00708               Double_t sn = -(xh-lad-&gt;<a class="code" href="classTkObject.html#o1">pos</a>[0])*sign/TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#o31">_SensorPitchK</a>;
00709               TH3F *hist1 = (TH3F*)AlignObject::sharray.At(6+l);
00710               TH3F *hist2 = (TH3F*)AlignObject::sharray.At(8+l);
00711               hist1-&gt;Fill(<span class="keywordtype">id</span>,  a, res[j][l]*10);
00712               hist2-&gt;Fill(<span class="keywordtype">id</span>, sn, res[j][l]*10);
00713             }
00714           }
00715           ntot++;
00716           chi2a += chi2;
00717         }
00718       }
00719     }
00720   }
00721 
00722   ifstream ftmp(Form(<span class="stringliteral">"/proc/%d/status"</span>, gSystem-&gt;GetPid()));
00723   TString sbuf;
00724   Float_t vmsize = 0;
00725   <span class="keywordflow">while</span> (!sbuf.ReadToken(ftmp).eof()) {
00726     <span class="keywordflow">if</span> (sbuf == <span class="stringliteral">"VmSize:"</span>) {
00727       ftmp &gt;&gt; vmsize;
00728       <span class="keywordflow">break</span>;
00729     }
00730   }
00731 
00732   chi2a = chi2a/ntot;
00733   std::cout &lt;&lt; Form(<span class="stringliteral">" iter %3d %8.3f %7d %4.0f sec %5.1f MB"</span> ,
00734                     iter, chi2a, ntot,
00735                     timer.CpuTime()-ptime, vmsize/1024) &lt;&lt; std::endl;
00736   ptime = timer.CpuTime();
00737   timer.Continue();
00738 
00739   <span class="keywordflow">if</span> (iter == miter) <span class="keywordflow">break</span>;
00740 
00741   Int_t bits = 0;
00742   <span class="keywordflow">if</span>      (iter == 0) bits = AlignObject::XYcorr2;
00743   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iter == 1) bits = AlignObject::Zcorr2;
00744   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iter == 2) bits = AlignObject::XYcorr1 | AlignObject::Zcorr2 |
00745                              AlignObject::dYXcorr;
00746   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iter &lt; 15) bits = AlignObject::XYcorr1 | 
00747                              AlignObject::dYXcorr | AlignObject::dZXcorr;
00748   <span class="keywordflow">else</span>                bits = AlignObject::XYcorr3;
00749 
00750   AlignObject::ProfMode = 1;
00751   <span class="keywordflow">if</span> (iter == miter-1) AlignObject::ProfMode = 2;
00752 
00753   <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nplan; i++) {
00754     <span class="keywordflow">for</span> (Int_t j = 0; j &lt; Nlad; j++) {
00755       <span class="keywordflow">for</span> (Int_t k = 0; k &lt; Nhalf; k++) {
00756         Int_t slot = j+1;
00757         Int_t sign = (k == 0) ? -1 : 1;
00758         Int_t tkid = sign*((i+1)*100+slot);
00759         <a class="code" href="classAlignObject.html">AlignObject</a> *algp = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00760         <span class="keywordflow">if</span> (!algp) <span class="keywordflow">continue</span>;
00761 
00762         algp-&gt;<a class="code" href="classAlignObject.html#a7">ProcHists</a>(bits);
00763       }
00764     }
00765   }
00766 
00767   <span class="keywordflow">if</span> (iter == 0) xf[0] = chi2a;
00768   <span class="keywordflow">else</span> xf[1] = chi2a;
00769 
00770   chi2o = chi2a;
00771  }
00772 
00773   std::cout &lt;&lt; <span class="stringliteral">"CpuTime "</span> &lt;&lt; timer.CpuTime() &lt;&lt; std::endl;
00774 }
00775 
<a name="l00776"></a><a class="code" href="classAlignFit.html#a12">00776</a> <span class="keywordtype">void</span> <a class="code" href="classAlignFit.html#a12">AlignFit::Get</a>(Float_t arr[Ndim][8], Int_t what)
00777 {
00778   <span class="keywordflow">for</span> (Int_t j = what/2-1; j &lt; Nlad; j++) {
00779     <span class="keywordflow">for</span> (Int_t k = what%2; k &lt; Nhalf; k++) {
00780       <span class="keywordflow">for</span> (Int_t i = 0; i &lt; Nplan; i++) {
00781 
00782         Int_t slot = j+1;
00783         Int_t sign = (k == 0) ? -1 : 1;
00784         Int_t tkid = sign*((i+1)*100+slot);
00785         <a class="code" href="classAlignObject.html">AlignObject</a> *algp = <a class="code" href="classAlignFit.html#a8">FindTkId</a>(tkid);
00786 
00787         <span class="keywordflow">for</span> (Int_t l = 0; l &lt; 3; l++) {
00788           arr  [l][i] = (algp) ? algp-&gt;<a class="code" href="classAlignObject.html#o2">param</a>[l] : 0;
00789           arr[8+l][i] = (algp) ? algp-&gt;<a class="code" href="classAlignObject.html#o0">cool</a> [l] : 0;
00790         }
00791         arr[3][i] = (algp) ? algp-&gt;<a class="code" href="classAlignObject.html#o6">pitch</a> : 0;
00792         arr[4][i] = (algp) ? algp-&gt;<a class="code" href="classAlignObject.html#o4">phi</a>   : 0;
00793         arr[5][i] = (algp) ? algp-&gt;<a class="code" href="classAlignObject.html#o8">roll</a>  : 0;
00794         arr[6][i] = j+1;
00795         arr[7][i] = k+1;
00796       }
00797       <span class="keywordflow">return</span>;
00798     }
00799   }
00800 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Nov 18 18:21:01 2008 for  AMS Software: Geometry Classes by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
