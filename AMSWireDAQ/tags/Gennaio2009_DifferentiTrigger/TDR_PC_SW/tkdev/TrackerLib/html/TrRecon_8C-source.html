<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title> AMS Software: Geometry Classes: CC/TrRecon.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">CC</a></div>
<h1>TrRecon.C</h1><a href="TrRecon_8C.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00002 
00020 
00021 <span class="preprocessor">#include "<a class="code" href="TrRecon_8h.html">TrRecon.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="TrMap_8h.html">TrMap.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="tkdcards_8h.html">tkdcards.h</a>"</span>
00024 <span class="preprocessor">#include "TrField.h"</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="TrTrack_8h.html">TrTrack.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="TkSens_8h.html">TkSens.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="TrMCCluster_8h.html">TrMCCluster.h</a>"</span>
00029 
<a name="l00030"></a><a class="code" href="classTrRecon.html#s7">00030</a> <a class="code" href="classVCon.html">VCon</a>* <a class="code" href="classTrRecon.html#s7">TrRecon::TRCon</a>=0;
00031 
00032 
<a name="l00033"></a><a class="code" href="classTrRecon.html#s6">00033</a> <a class="code" href="classTrRecon.html">TrRecon</a>* <a class="code" href="classTrRecon.html#s6">TrRecon::Head</a>=0;
<a name="l00034"></a><a class="code" href="classTrRecon.html#v0">00034</a> <a class="code" href="classTrCalDB.html">TrCalDB</a>* <a class="code" href="classTrRecon.html#v0">TrRecon::_trcaldb</a>=0;
00035 
<a name="l00036"></a><a class="code" href="classTrRecon.html#e1">00036</a> <a class="code" href="classTrRecon.html">TrRecon</a>* <a class="code" href="classTrRecon.html#e1">TrRecon::Create</a>(<span class="keywordtype">int</span> recreate){
00037   <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#s6">Head</a> &amp;&amp; !recreate){
00038     printf(<span class="stringliteral">"TrRecon::Create Warning a Trecon instance already exist!\n"</span>);
00039     <span class="keywordflow">return</span> Head;
00040   }
00041   <span class="keywordflow">if</span>( (<a class="code" href="classTrRecon.html#s6">Head</a> &amp;&amp; recreate)||(!Head))
00042     <a class="code" href="classTrRecon.html#s6">Head</a>= <span class="keyword">new</span> <a class="code" href="classTrRecon.html#d0">TrRecon</a>();
00043   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; BUFSIZE; i++) {
00044     <a class="code" href="classTrRecon.html#t8">_adcbuf2</a>[i] =  0;
00045     <a class="code" href="classTrRecon.html#t9">_sigbuf2</a>[i] =  -1;
00046     <a class="code" href="classTrRecon.html#t10">_stabuf2</a>[i] =  -1;
00047   } 
00048 
00049   <span class="keywordflow">return</span> Head;
00050 }
00051 
00052 <span class="comment">// clustering - parameters</span>
<a name="l00053"></a><a class="code" href="classTrRecon.html#s0">00053</a> <span class="keywordtype">float</span>       <a class="code" href="classTrRecon.html#s0">TrRecon::ThrSeed</a>[2]  = {4.00,4.00};
<a name="l00054"></a><a class="code" href="classTrRecon.html#s1">00054</a> <span class="keywordtype">float</span>       <a class="code" href="classTrRecon.html#s1">TrRecon::ThrNeig</a>[2]  = {1.00,1.00};
<a name="l00055"></a><a class="code" href="classTrRecon.html#s2">00055</a> <span class="keywordtype">int</span>         <a class="code" href="classTrRecon.html#s2">TrRecon::SeedDist</a>[2] = {   3,   3};
00056 
00057 <span class="comment">// clustering - analysis structure</span>
<a name="l00058"></a><a class="code" href="classTrRecon.html#t4">00058</a> <span class="keywordtype">float</span>       <a class="code" href="classTrRecon.html#t4">TrRecon::_adcbuf</a>[TrRecon::BUFSIZE];
<a name="l00059"></a><a class="code" href="classTrRecon.html#t5">00059</a> <span class="keywordtype">float</span>       <a class="code" href="classTrRecon.html#t5">TrRecon::_sigbuf</a>[TrRecon::BUFSIZE];
<a name="l00060"></a><a class="code" href="classTrRecon.html#t6">00060</a> <span class="keywordtype">int</span>         <a class="code" href="classTrRecon.html#t6">TrRecon::_stabuf</a>[TrRecon::BUFSIZE];
00061 
<a name="l00062"></a><a class="code" href="classTrRecon.html#t8">00062</a> <span class="keywordtype">float</span>       <a class="code" href="classTrRecon.html#t8">TrRecon::_adcbuf2</a>[TrRecon::BUFSIZE];
<a name="l00063"></a><a class="code" href="classTrRecon.html#t9">00063</a> <span class="keywordtype">float</span>       <a class="code" href="classTrRecon.html#t9">TrRecon::_sigbuf2</a>[TrRecon::BUFSIZE];
<a name="l00064"></a><a class="code" href="classTrRecon.html#t10">00064</a> <span class="keywordtype">int</span>         <a class="code" href="classTrRecon.html#t10">TrRecon::_stabuf2</a>[TrRecon::BUFSIZE];
<a name="l00065"></a><a class="code" href="classTrRecon.html#t7">00065</a> vector&lt;int&gt; TrRecon::_seedaddresses;
00066 
00067 <span class="comment">// hit signal correlation (only muons/protons)</span>
<a name="l00068"></a><a class="code" href="classTrRecon.html#s3">00068</a> <span class="keywordtype">float</span>  <a class="code" href="classTrRecon.html#s3">TrRecon::GGpars</a>[6]  = {1428.,0.0000,0.1444,1645.,0.0109,0.0972};
<a name="l00069"></a><a class="code" href="classTrRecon.html#s4">00069</a> <span class="keywordtype">float</span>  <a class="code" href="classTrRecon.html#s4">TrRecon::GGintegral</a> = 91765.;
<a name="l00070"></a><a class="code" href="classTrRecon.html#s5">00070</a> <span class="keywordtype">float</span>  <a class="code" href="classTrRecon.html#s5">TrRecon::ThrProb</a>    = 0.00001;
00071 
00072 
<a name="l00073"></a><a class="code" href="classTrRecon.html#a2">00073</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a2">TrRecon::SetParFromDataCards</a>(){
00074   <a class="code" href="classTrRecon.html#s0">ThrSeed</a>[0]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s0">ThrSeed</a>[0] ;
00075   <a class="code" href="classTrRecon.html#s0">ThrSeed</a>[1]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s0">ThrSeed</a>[1]  ;
00076   <a class="code" href="classTrRecon.html#s1">ThrNeig</a>[0]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s1">ThrNeig</a>[0]  ;
00077   <a class="code" href="classTrRecon.html#s1">ThrNeig</a>[1]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s1">ThrNeig</a>[1]  ;
00078   
00079   <a class="code" href="classTrRecon.html#s2">SeedDist</a>[0] = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s2">SeedDist</a>[0] ;
00080   <a class="code" href="classTrRecon.html#s2">SeedDist</a>[1] = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s2">SeedDist</a>[1] ;
00081   
00082   <a class="code" href="classTrRecon.html#s3">GGpars</a>[0]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s3">GGpars</a>[0]    ;
00083   <a class="code" href="classTrRecon.html#s3">GGpars</a>[1]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s3">GGpars</a>[1]    ;
00084   <a class="code" href="classTrRecon.html#s3">GGpars</a>[2]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s3">GGpars</a>[2]    ;
00085   <a class="code" href="classTrRecon.html#s3">GGpars</a>[3]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s3">GGpars</a>[3]    ;
00086   <a class="code" href="classTrRecon.html#s3">GGpars</a>[4]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s3">GGpars</a>[4]    ;
00087   <a class="code" href="classTrRecon.html#s3">GGpars</a>[5]  = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s3">GGpars</a>[5]    ;
00088   <a class="code" href="classTrRecon.html#s4">GGintegral</a> = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s4">GGintegral</a>   ;
00089   <a class="code" href="classTrRecon.html#s5">ThrProb</a>    = <a class="code" href="tkdcards_8h.html#a5">TRCLFFKEY</a>.<a class="code" href="classTrRecon.html#s5">ThrProb</a>      ;
00090   
00091 
00092 }
<a name="l00093"></a><a class="code" href="classTrRecon.html#a0">00093</a> <a class="code" href="classTrRecon.html#a0">TrRecon::~TrRecon</a>() {
00094   <a class="code" href="classTrRecon.html#a1">Clear</a>();
00095 }
00096 
<a name="l00097"></a><a class="code" href="classTrRecon.html#a1">00097</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a1">TrRecon::Clear</a>(Option_t *option) {
00098   <span class="comment">/*</span>
00099 <span class="comment">  for(int ii=0;ii&lt;2;ii++){</span>
00100 <span class="comment">    ThrSeed[ii]=0;</span>
00101 <span class="comment">    ThrNeig[ii]=0;</span>
00102 <span class="comment">    SeedDist[ii]=0;</span>
00103 <span class="comment">  }</span>
00104 <span class="comment">  //</span>
00105 <span class="comment">  memset(GGpars,0,6*sizeof(GGpars[0]));</span>
00106 <span class="comment">  GGintegral=0;</span>
00107 <span class="comment">  ThrProb=0;</span>
00108 <span class="comment">  */</span>
00109   <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>.clear();
00110   <a class="code" href="classTrRecon.html#p3">_RecHitLayerMap</a>.clear();
00111   <span class="comment">// _Patterns.clear();</span>
00112 }
00113 
00114 <span class="comment">// void TrRecon::PrintEvent() {</span>
00115 <span class="comment">//   // Summary</span>
00116 <span class="comment">//   printf("Summary:\n");</span>
00117 <span class="comment">//   printf("nRawClusters: %4d\n",GetEvent()-&gt;GetnTrRawClusters());</span>
00118 <span class="comment">//   printf("nTrClusters:  %4d\n",GetEvent()-&gt;GetnTrClusters());</span>
00119 <span class="comment">//   printf("nTrRecHits:   %4d\n",GetEvent()-&gt;GetnTrRecHits());</span>
00120 <span class="comment">//   printf("nTrTracks:    %4d\n",GetEvent()-&gt;GetnTrTracks());</span>
00121 <span class="comment">//   printf("\n");</span>
00122 <span class="comment">//   // Summary by ladder</span>
00123 <span class="comment">//   BuildClusterTkIdMap();</span>
00124 <span class="comment">//   printf("List of the %3d active ladders: \n",GetnActiveLadders());</span>
00125 <span class="comment">//   for (int tt=0; tt&lt;GetnActiveLadders(); tt++) {</span>
00126 <span class="comment">//     int tkid = GetTkIdActiveLadder(tt);</span>
00127 <span class="comment">//     printf("TkId: %4d  nXCluster: %3d  nYCluster: %3d\n",</span>
00128 <span class="comment">//            tkid,GetnTrClusters(tkid,0),GetnTrClusters(tkid,1));</span>
00129 <span class="comment">//   }</span>
00130 <span class="comment">//   printf("\n");</span>
00131 <span class="comment">//   // Summary by layer</span>
00132 <span class="comment">//   BuildRecHitLayerMap();</span>
00133 <span class="comment">//   printf("Numbers of hits per layer: \n");</span>
00134 <span class="comment">//   for (int ll=1; ll&lt;9; ll++) {</span>
00135 <span class="comment">//     printf("Layer: %1d  nHits: %3d\n",ll,GetnTrRecHits(ll));</span>
00136 <span class="comment">//   }</span>
00137 <span class="comment">//   printf("\n");</span>
00138 <span class="comment">//   // Hit list</span>
00139 <span class="comment">//   printf("Hit list (without multiplicity on x coordinate): \n");</span>
00140 <span class="comment">//   for (int hh=0; hh&lt;GetEvent()-&gt;GetnTrRecHits(); hh++) {</span>
00141 <span class="comment">//     AMSTrRecHit* hit   = GetEvent()-&gt;GetTrRecHit(hh);</span>
00142 <span class="comment">//     AMSPoint  point = hit-&gt;GetGlobalCoordinate();</span>
00143 <span class="comment">//     printf("Hit: %3d  (x,y,z)=(%10.4f,%10.4f,%10.4f)  mult: %1d  corr: %8.4f  prob: %7.5f  stat: %2d\n",</span>
00144 <span class="comment">//            hh,point.x(),point.y(),point.z(),hit-&gt;GetMultiplicity(),hit-&gt;GetCorrelation(),hit-&gt;GetProb(),hit-&gt;GetStatus());</span>
00145 <span class="comment">//   }</span>
00146 <span class="comment">//   printf("\n");</span>
00147 <span class="comment">//  // Track list</span>
00148 <span class="comment">//   printf("Track list: \n");</span>
00149 <span class="comment">//   for (int tt=0; tt&lt;GetEvent()-&gt;GetnTrTracks(); tt++) {</span>
00150 <span class="comment">//     TrTrack* track  = GetEvent()-&gt;GetTrTrack(tt);</span>
00151 <span class="comment">//     printf("nTrack: %2d  (x0,y0,z0)=(%8.4f,%8.4f,%8.4f)  (Theta,Phi)=(%9.6f,%9.6f)  nPoints: %1d  Chi2: %10.4f\n",</span>
00152 <span class="comment">//            tt,track-&gt;GetP0x(),track-&gt;GetP0y(),track-&gt;GetP0z(),</span>
00153 <span class="comment">//            track-&gt;GetTheta(),track-&gt;GetPhi(),track-&gt;GetNhits(),track-&gt;GetChisq());</span>
00154 <span class="comment">//   }</span>
00155 <span class="comment">//   printf("\n");</span>
00156 <span class="comment">// }</span>
00157 
00158 
00159 
00161 <span class="comment">// --- CLUSTERS --- //</span>
00163 <span class="comment"></span>
<a name="l00164"></a><a class="code" href="classTrRecon.html#a7">00164</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a7">TrRecon::ClearBuffer</a>() {
00165  
00166 
00167 
00168   memcpy(<a class="code" href="classTrRecon.html#t4">_adcbuf</a>, <a class="code" href="classTrRecon.html#t8">_adcbuf2</a>,<a class="code" href="classTrRecon.html#x2x1">BUFSIZE</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00169   memcpy(<a class="code" href="classTrRecon.html#t5">_sigbuf</a>, <a class="code" href="classTrRecon.html#t9">_sigbuf2</a>,<a class="code" href="classTrRecon.html#x2x1">BUFSIZE</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00170   memcpy(<a class="code" href="classTrRecon.html#t6">_stabuf</a>, <a class="code" href="classTrRecon.html#t10">_stabuf2</a>,<a class="code" href="classTrRecon.html#x2x1">BUFSIZE</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00171 
00172   <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.clear();
00173 }
00174 
<a name="l00175"></a><a class="code" href="classTrRecon.html#a8">00175</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a8">TrRecon::ExpandClusterInBuffer</a>(<a class="code" href="classAMSTrRawCluster.html">AMSTrRawCluster</a>* cluster) {
00176   <span class="keywordtype">int</span> entries = 0;
00177   <span class="keywordtype">int</span> nelements = cluster-&gt;<a class="code" href="classAMSTrRawCluster.html#a15">GetNelem</a>();
00178   <span class="keywordtype">int</span> firststripaddress = cluster-&gt;<a class="code" href="classAMSTrRawCluster.html#a13">GetAddress</a>();
00179   <a class="code" href="classTrRecon.html#r0">cal</a> = <a class="code" href="classTrRecon.html#a3">GetTrCalDB</a>()-&gt;<a class="code" href="classTrCalDB.html#a10">FindCal_TkId</a>(cluster-&gt;<a class="code" href="classAMSTrRawCluster.html#a7">GetTkId</a>());
00180   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=0; jj&lt;nelements; jj++) {
00181     <span class="keywordtype">int</span> address = firststripaddress + jj;
00182     <span class="keywordflow">if</span> ( (address&lt;0)||(address&gt;=1024) ) <span class="keywordflow">continue</span>;
00183     <a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address] = cluster-&gt;<a class="code" href="classAMSTrRawCluster.html#a16">GetSignal</a>(jj);
00184     <a class="code" href="classTrRecon.html#t5">_sigbuf</a>[address] = <a class="code" href="classTrRecon.html#r0">cal</a>-&gt;<a class="code" href="classTrLadCal.html#a11">GetSigma</a>(address);
00185     <a class="code" href="classTrRecon.html#t6">_stabuf</a>[address] = <a class="code" href="classTrRecon.html#r0">cal</a>-&gt;<a class="code" href="classTrLadCal.html#a13">GetStatus</a>(address);
00186     entries++;
00187   }
00188   <span class="keywordflow">return</span> entries;
00189 }
00190 
00191 
<a name="l00192"></a><a class="code" href="classTrRecon.html#a13">00192</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a13">TrRecon::GetAddressInSubBuffer</a>(<span class="keywordtype">int</span> address, <span class="keywordtype">int</span> first, <span class="keywordtype">int</span> last, <span class="keywordtype">int</span> ciclicity) {
00193   <span class="comment">// by default returns the address</span>
00194   <span class="keywordflow">if</span> ( (address&lt;last)&amp;&amp;(address&gt;=first) ) <span class="keywordflow">return</span> address;
00195   <span class="comment">// if not cyclic returns the first strip in case of underflow and the last-1 in case of overflow  </span>
00196   <span class="keywordflow">if</span> (ciclicity==0) <span class="keywordflow">return</span> TMath::Max(first,TMath::Min(address,last-1));
00197   <span class="comment">// if cyclic adds the interval (last-first)</span>
00198   <span class="keywordflow">return</span> (address&gt;=last) ? (address-(last-first)) : (address+(last-first));
00199 }
00200 
00201 
<a name="l00202"></a><a class="code" href="classTrRecon.html#a9">00202</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a9">TrRecon::BuildTrClusters</a>(<span class="keywordtype">int</span> rebuild) { 
00203   <span class="comment">//Get the pointer to the TrRawCluster container</span>
00204   <span class="comment">//  AMSContainer* cont=GetCont(AMSID("AMSTrRawCluster"));</span>
00205   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrRawCluster"</span>);
00206   <span class="keywordflow">if</span>(!cont){
00207     printf(<span class="stringliteral">"TrRecon::BuildTrClusters  Cant Find AMSTrRawCluster Container Reconstruction is Impossible !!!\n"</span>);
00208     <span class="keywordflow">return</span> -1;
00209   }
00210   <span class="keywordflow">if</span>(cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>()==0){
00211     printf(<span class="stringliteral">"TrRecon::BuildTrClusters  AMSTrRawCluster Container is Empty  Reconstruction is Impossible !!!\n"</span>);
00212     <span class="keywordflow">return</span> -1;
00213   }
00214 
00215 
00216   <a class="code" href="classVCon.html">VCon</a>* cont2=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrCluster"</span>);
00217   <span class="keywordflow">if</span>(!cont2){
00218     printf(<span class="stringliteral">"TrRecon::BuildTrClusters  Cant Find AMSTrCluster Container Reconstruction is Impossible !!!\n"</span>);
00219     <span class="keywordflow">return</span> -1;
00220   }
00221   <span class="comment">//empty the destination container if requested</span>
00222   <span class="keywordflow">if</span>(rebuild) cont2-&gt;<a class="code" href="classVCon.html#a4">eraseC</a>();
00223 
00224 
00225   <span class="comment">//Build The Map of TrRawClusters</span>
00226   <a class="code" href="classTrMap.html">TrMap&lt;AMSTrRawCluster&gt;</a> RawMap;
00227 
00228 
00229   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=0;ii&lt; cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>();ii++){
00230     <a class="code" href="classAMSTrRawCluster.html">AMSTrRawCluster</a>* clu=(<a class="code" href="classAMSTrRawCluster.html">AMSTrRawCluster</a>*)cont-&gt;<a class="code" href="classVCon.html#a5">getelem</a>(ii);
00231     <span class="keywordflow">if</span> (clu)  RawMap.<a class="code" href="classTrMap.html#a3">Add</a>(clu);
00232   }
00233 
00234 
00235 
00236   <span class="comment">//  RawMap.info();</span>
00237   <span class="comment">// loop on ladders</span>
00238   <a class="code" href="classTrMap.html">TrMap&lt;AMSTrRawCluster&gt;</a>::TrMapIT lad=RawMap.<a class="code" href="classTrMap.html#o0">LadMap</a>.begin();
00239   <span class="keywordflow">while</span> (lad!=RawMap.<a class="code" href="classTrMap.html#o0">LadMap</a>.end()){
00240     <a class="code" href="classTrRecon.html#a7">ClearBuffer</a>();
00241     <span class="comment">//expand clusters in the buffer</span>
00242     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iclus=0; iclus&lt;lad-&gt;second.size(); iclus++) 
00243       <a class="code" href="classTrRecon.html#a8">ExpandClusterInBuffer</a>( lad-&gt;second.at(iclus) );
00244     
00245     <span class="keywordtype">int</span> TkId=lad-&gt;first;
00246     <span class="keywordtype">int</span> layer = abs(TkId/100);
00247     <span class="keywordtype">int</span> ncls=<a class="code" href="classTrRecon.html#a10">BuildTrClustersInSubBuffer</a>(TkId,0,640,0);      <span class="comment">// S</span>
00248     <span class="comment">//printf("TkId: %+03d Found %d cluster on S\n",TkId,ncls);</span>
00249     <span class="comment">//printf("TrCluster container has: %d elements\n",cont2-&gt;getnelem());</span>
00250     <span class="keywordflow">if</span> ( (layer==1)||(layer==8) ) { 
00251       <a class="code" href="classTrRecon.html#a10">BuildTrClustersInSubBuffer</a>(TkId,640,1024,1); <span class="comment">// K7</span>
00252     }
00253     <span class="keywordflow">else</span> { 
00254       <a class="code" href="classTrRecon.html#a10">BuildTrClustersInSubBuffer</a>(TkId,640,832,0);  <span class="comment">// K5 - sensor1</span>
00255       <a class="code" href="classTrRecon.html#a10">BuildTrClustersInSubBuffer</a>(TkId,832,1024,0); <span class="comment">// K5 - sensor2 </span>
00256     }
00257     lad++;
00258   }
00259 
00260   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00261   <span class="keywordflow">if</span>(cont2) <span class="keyword">delete</span> cont2;
00262   <span class="keywordflow">return</span> 0;
00263 }
00264 
00265 
<a name="l00266"></a><a class="code" href="classTrRecon.html#a10">00266</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a10">TrRecon::BuildTrClustersInSubBuffer</a>(<span class="keywordtype">int</span> tkid, <span class="keywordtype">int</span> first, <span class="keywordtype">int</span> last, <span class="keywordtype">int</span> cyclicity) {
00267   <span class="keywordtype">int</span>   ntrclusters = 0;
00268   <span class="keywordtype">int</span>   side = (first&gt;639)?0:1;
00269   <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#v0">_trcaldb</a>==0) {
00270     printf(<span class="stringliteral">"TrRecon::BuildTrClustersInSubBuffer Error, no _trcaldb specified.\n"</span>);
00271     <span class="keywordflow">return</span> -9999; 
00272   }
00273   <a class="code" href="classTrRecon.html#r0">cal</a> = <a class="code" href="classTrRecon.html#a3">GetTrCalDB</a>()-&gt;<a class="code" href="classTrCalDB.html#a10">FindCal_TkId</a>(tkid);
00274   <span class="keywordflow">if</span> (!cal) {printf (<span class="stringliteral">"TrRecon::BuildTrClustersInSubBuffer, WARNING calibration not found!!\n"</span>); <span class="keywordflow">return</span> -9999;}
00275   <span class="comment">// create a list of seeds </span>
00276   <span class="keywordtype">int</span> nseeds = <a class="code" href="classTrRecon.html#a11">BuildSeedListInSubBuffer</a>(first, last, cyclicity);
00277 <span class="comment">//   printf("Found %d seeds\n",nseeds);</span>
00278 <span class="comment">//   for (int jj=0;jj&lt;nseeds;jj++) printf("seed %d  %d\n",jj,_seedaddresses.at(jj));</span>
00279 
00280   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrCluster"</span>);
00281 
00282   <span class="comment">// loop on seeds</span>
00283   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ss=0; ss&lt;nseeds; ss++) {
00284     <span class="keywordtype">int</span> seedaddress  = <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.at(ss);
00285     <span class="keywordtype">int</span> boundary     = <a class="code" href="classTrRecon.html#a12">GetBoundariesInSubBuffer</a>(ss,first,last,cyclicity);
00286     <span class="keywordtype">int</span> leftaddress  = boundary/10000;             
00287     <span class="keywordtype">int</span> rightaddress = boundary-leftaddress*10000; 
00288     <span class="keywordtype">int</span> length       = (leftaddress&lt;=rightaddress) ? rightaddress-leftaddress+1 : last-leftaddress+rightaddress-first+1;
00289     <span class="keywordtype">int</span> seedind      = (seedaddress&gt;=leftaddress)  ? seedaddress-leftaddress    : last-leftaddress+seedaddress-first;  
00290     <span class="keywordtype">float</span> sigg[1024];
00291     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=0; jj&lt;length; jj++) { 
00292       <span class="keywordtype">int</span> address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(leftaddress+jj,first,last,cyclicity);
00293       sigg[jj]=<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address];
00294     }
00295 
00296     <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* cluster = <span class="keyword">new</span> <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>(tkid,side,leftaddress,length,seedind,sigg,0);
00297     cluster-&gt;<a class="code" href="classAMSTrCluster.html#a4">BuildCoordinates</a>();
00298     <span class="keywordflow">if</span>(cont) cont-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(cluster);
00299     ntrclusters++;   
00300   }
00301   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00302   <span class="keywordflow">return</span> ntrclusters;
00303 }
00304 
<a name="l00305"></a><a class="code" href="classTrRecon.html#a11">00305</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a11">TrRecon::BuildSeedListInSubBuffer</a>(<span class="keywordtype">int</span> first, <span class="keywordtype">int</span> last, <span class="keywordtype">int</span> cyclicity) {
00306   <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.clear();
00307   <span class="keywordtype">int</span> side    = (first&gt;639) ? 0 : 1;
00308   <span class="keywordtype">int</span> address = 0;
00309   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=first; ii&lt;last; ii++) {
00310     <span class="comment">// 1. the strip has to be well defined</span>
00311     <span class="comment">// 2. a noisy strip can't be a seed strip</span>
00312     <span class="comment">// 3. the seed must exceed the ThrSeed S/N threshold</span>
00313     <span class="keywordflow">if</span> (  (<a class="code" href="classTrRecon.html#t5">_sigbuf</a>[ii]&lt;=0.)||(<a class="code" href="classTrRecon.html#t6">_stabuf</a>[ii]!=0)||( (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[ii]/<a class="code" href="classTrRecon.html#t5">_sigbuf</a>[ii])&lt;<a class="code" href="classTrRecon.html#s0">ThrSeed</a>[side] )  ) <span class="keywordflow">continue</span>;
00314     <span class="comment">// 4. if the next strip is good, above threeshold and with signal larger than this one continue</span>
00315     <span class="keywordflow">if</span>( ii&lt;(last-1)&amp;&amp;(<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[ii+1]&gt;<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[ii]))
00316       <span class="keywordflow">if</span> ((<a class="code" href="classTrRecon.html#t5">_sigbuf</a>[ii+1]&gt;0.)&amp;&amp;(<a class="code" href="classTrRecon.html#t6">_stabuf</a>[ii+1]==0)&amp;&amp;( (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[ii+1]/<a class="code" href="classTrRecon.html#t5">_sigbuf</a>[ii+1])&gt;=<a class="code" href="classTrRecon.html#s0">ThrSeed</a>[side]))
00317         <span class="keywordflow">continue</span>;
00318 
00319     <span class="comment">// 5. the seed has to be the local maximum among 2*SeedDist+1 good (with status==0) strips</span>
00320     <span class="keywordtype">bool</span> localmax = <span class="keyword">true</span>;
00321     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=1; jj&lt;=<a class="code" href="classTrRecon.html#s2">SeedDist</a>[side]; jj++) {
00322       <span class="comment">// right</span>
00323       address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(ii+jj,first,last,cyclicity);
00324       <span class="keywordflow">if</span> ( (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[ii]&lt;=<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address])&amp;&amp;(<a class="code" href="classTrRecon.html#t6">_stabuf</a>[address]==0) ) { localmax = <span class="keyword">false</span>; <span class="keywordflow">break</span>; }
00325       <span class="comment">// left</span>
00326       address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(ii-jj,first,last,cyclicity);
00327       <span class="keywordflow">if</span> ( (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[ii]&lt;=<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address])&amp;&amp;(<a class="code" href="classTrRecon.html#t6">_stabuf</a>[address]==0) ) { localmax = <span class="keyword">false</span>; <span class="keywordflow">break</span>; }
00328     }
00329     <span class="comment">// is not a local maximum</span>
00330     <span class="keywordflow">if</span> (!localmax) <span class="keywordflow">continue</span>;
00331     <span class="comment">// A SEED IS CATCHED</span>
00332     <span class="keywordtype">int</span> seedaddress = ii;
00333     <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.push_back(seedaddress);
00334   }
00335   <span class="keywordflow">return</span> <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.size();
00336 }
00337 
<a name="l00338"></a><a class="code" href="classTrRecon.html#a12">00338</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a12">TrRecon::GetBoundariesInSubBuffer</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">int</span> first, <span class="keywordtype">int</span> last, <span class="keywordtype">int</span> cyclicity) {
00339 
00340   <span class="comment">// the seeds vector</span>
00341   <span class="keywordtype">int</span> side         = (first&gt;639)?0:1;
00342   <span class="keywordtype">int</span> nseeds       = <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.size();
00343   <span class="keywordtype">int</span> seedaddress  = <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.at(index);
00344 
00346   <span class="keywordtype">int</span> leftaddress  = seedaddress;
00347   <span class="keywordtype">int</span> rightaddress = seedaddress;
00348 
00350   <span class="keywordtype">int</span> left  = (index&lt;=0) ? first : <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.at(index-1);
00351   <span class="keywordflow">if</span> ( (cyclicity!=0)&amp;&amp;(index&lt;=0) ) left = <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.at(nseeds-1);
00352   <span class="keywordtype">int</span> right = (index&gt;=(nseeds-1)) ? last-1 : <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.at(index+1);
00353   <span class="keywordflow">if</span> ((cyclicity!=0)&amp;&amp;(index&gt;=(nseeds-1))) right = <a class="code" href="classTrRecon.html#t7">_seedaddresses</a>.at(0);
00354 
00355   <span class="comment">// search for the left boundary</span>
00356   <span class="keywordtype">int</span> address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(leftaddress-1,first,last,cyclicity); 
00357   <span class="keywordflow">while</span> (address!=left) { 
00358     <span class="comment">// the neighboring strip must exceed the ThrNeig S/N threshold</span>
00359     <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address]/<a class="code" href="classTrRecon.html#t5">_sigbuf</a>[address]&lt;=<a class="code" href="classTrRecon.html#s1">ThrNeig</a>[side]) <span class="keywordflow">break</span>;
00360     <span class="comment">// the neighboring strip signal has to be smaller than the seed one</span>
00361     <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address]&gt;<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[seedaddress]) <span class="keywordflow">break</span>;   
00362     <span class="comment">// the strip is good</span>
00363     leftaddress--;
00364     <span class="comment">// new strip under analysis</span>
00365     address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(leftaddress-1,first,last,cyclicity);
00366   } 
00367   leftaddress = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(leftaddress,first,last,cyclicity);
00368 
00369   <span class="comment">// search for the right boundary</span>
00370   address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(rightaddress+1,first,last,cyclicity); 
00371   <span class="keywordflow">while</span> (address!=right) { 
00372     <span class="comment">// the neighboring strip must exceed the ThrNeig S/N threshold</span>
00373     <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address]/<a class="code" href="classTrRecon.html#t5">_sigbuf</a>[address]&lt;=<a class="code" href="classTrRecon.html#s1">ThrNeig</a>[side]) <span class="keywordflow">break</span>;
00374     <span class="comment">// the neighboring strip signal has to be smaller than the seed one</span>
00375     <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[address]&gt;<a class="code" href="classTrRecon.html#t4">_adcbuf</a>[seedaddress]) <span class="keywordflow">break</span>;   
00376     <span class="comment">// the strip is good</span>
00377     rightaddress++;
00378     <span class="comment">// new strip under analysis</span>
00379     address = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(rightaddress+1,first,last,cyclicity);
00380   } 
00381   rightaddress = <a class="code" href="classTrRecon.html#a13">GetAddressInSubBuffer</a>(rightaddress,first,last,cyclicity);
00382 
00383   <span class="keywordflow">return</span> 10000*leftaddress + rightaddress; 
00384 }
00385 
00386 
00388 <span class="comment">// --- HITS --- //</span>
00390 <span class="comment"></span>
00391 <span class="keywordtype">float</span> <a class="code" href="classTrRecon.html#a15">TrRecon::GetCorrelation</a>(<a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* cln, <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* clp) { 
00392   <span class="keywordflow">if</span> (!cln) <span class="keywordflow">return</span> -1.;
00393   <span class="keywordflow">if</span> (!clp) <span class="keywordflow">return</span>  1.;
00394   <span class="keywordtype">float</span> n = cln-&gt;<a class="code" href="classAMSTrCluster.html#a32">GetTotSignal</a>(<span class="stringliteral">"AGLN"</span>);
00395   <span class="keywordtype">float</span> p = clp-&gt;<a class="code" href="classAMSTrCluster.html#a32">GetTotSignal</a>(<span class="stringliteral">"AGLN"</span>);
00396   <span class="keywordflow">return</span> (p - n)/(p + n); 
00397 }
00398 
<a name="l00399"></a><a class="code" href="classTrRecon.html#a17">00399</a> <span class="keywordtype">float</span>  <a class="code" href="classTrRecon.html#a17">TrRecon::GetProbToBeCorrelated</a>(<span class="keywordtype">float</span> n, <span class="keywordtype">float</span> p) {
00400   <span class="keywordtype">float</span> correlation = <a class="code" href="classTrRecon.html#a15">GetCorrelation</a>(n,p);
00401   <span class="keywordflow">return</span> ( <a class="code" href="classTrRecon.html#s3">GGpars</a>[0]*TMath::Gaus(correlation,<a class="code" href="classTrRecon.html#s3">GGpars</a>[1],<a class="code" href="classTrRecon.html#s3">GGpars</a>[2],kFALSE) +
00402            <a class="code" href="classTrRecon.html#s3">GGpars</a>[3]*TMath::Gaus(correlation,<a class="code" href="classTrRecon.html#s3">GGpars</a>[4],<a class="code" href="classTrRecon.html#s3">GGpars</a>[5],kFALSE) ) / GGintegral;
00403 }
00404 
00405 <span class="keywordtype">float</span>  <a class="code" href="classTrRecon.html#a17">TrRecon::GetProbToBeCorrelated</a>(<a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* cln, <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* clp) {
00406   <span class="keywordtype">float</span> correlation = <a class="code" href="classTrRecon.html#a15">GetCorrelation</a>(cln,clp);
00407   <span class="keywordflow">return</span> ( GGpars[0]*TMath::Gaus(correlation,GGpars[1],GGpars[2],kFALSE) +
00408            GGpars[3]*TMath::Gaus(correlation,GGpars[4],GGpars[5],kFALSE) ) / GGintegral;
00409 }
00410 
<a name="l00411"></a><a class="code" href="classTrRecon.html#a19">00411</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a19">TrRecon::BuildClusterTkIdMap</a>() {
00412   <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>.clear();
00413   <span class="comment">// loop on TrClusters</span>
00414   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrCluster"</span>);
00415   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=0;ii&lt;cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>();ii++){
00416     <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* cluster = (<a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>*)cont-&gt;<a class="code" href="classVCon.html#a5">getelem</a>(ii);
00417     <span class="keywordtype">int</span> tkid = cluster-&gt;<a class="code" href="classAMSTrCluster.html#a9">GetTkId</a>();
00418     <span class="keywordtype">int</span> side = cluster-&gt;<a class="code" href="classAMSTrCluster.html#a12">GetSide</a>();
00419     <span class="comment">// add the cluster in the vector of the map (if the tkid doesn't exists create the entry)</span>
00420     <span class="keywordflow">if</span>(side==0) 
00421       <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>[tkid].first.<a class="code" href="classAMSTrCluster.html#a3">push_back</a>(cluster);
00422     <span class="keywordflow">else</span> 
00423       <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>[tkid].second.<a class="code" href="classAMSTrCluster.html#a3">push_back</a>(cluster);
00424   }
00425   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00426 }
00427 
00428 
<a name="l00429"></a><a class="code" href="classTrRecon.html#a21">00429</a> <span class="keywordtype">int</span>  <a class="code" href="classTrRecon.html#a21">TrRecon::GetnTrClusters</a>(<span class="keywordtype">int</span> tkid, <span class="keywordtype">int</span> side) { 
00430   <span class="keywordflow">return</span> (side==0) ? <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>[tkid].first.size() : <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>[tkid].second.size(); 
00431 }
00432 
<a name="l00433"></a><a class="code" href="classTrRecon.html#a22">00433</a> <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* <a class="code" href="classTrRecon.html#a22">TrRecon::GetTrCluster</a>(<span class="keywordtype">int</span> tkid, <span class="keywordtype">int</span> side, <span class="keywordtype">int</span> iclus) { 
00434   <span class="keywordflow">return</span> (side==0) ? <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>[tkid].first.at(iclus) : <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>[tkid].second.at(iclus); 
00435 }
00436 
00437 <span class="comment">//================================================================================================</span>
00438 <span class="comment">//================================================================================================</span>
00439 
<a name="l00440"></a><a class="code" href="classTrRecon.html#a23">00440</a> <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a23">TrRecon::BuildTrRecHits</a>(<span class="keywordtype">int</span> rebuild) {
00441 
00442   
00443   <span class="comment">//Get the pointer to the TrCluster container</span>
00444   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrCluster"</span>);
00445   <span class="keywordflow">if</span>(!cont){
00446     printf(<span class="stringliteral">"TrRecon::BuildTrRecHit  Cant Find AMSTrCluster Container Reconstruction is Impossible !!!\n"</span>);
00447     <span class="keywordflow">return</span> -1;
00448   }
00449   <span class="keywordflow">if</span>(cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>()==0){
00450     printf(<span class="stringliteral">"TrRecon::BuildTrRecHit  AMSTrCluster Container is Empty  Reconstruction is Impossible !!!\n"</span>);
00451     <span class="keywordflow">return</span> -1;
00452   }
00453 
00454   <a class="code" href="classVCon.html">VCon</a>* cont2=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrRecHit"</span>);
00455   <span class="keywordflow">if</span>(!cont2){
00456     printf(<span class="stringliteral">"TrRecon::BuildTrRecHit  Cant Find AMSTrRecHit Container Reconstruction is Impossible !!!\n"</span>);
00457     <span class="keywordflow">return</span> -1;
00458   }
00459  
00460   <a class="code" href="classTrRecon.html#a19">BuildClusterTkIdMap</a>();
00461 
00462   <span class="keywordtype">int</span> ntrrechits = 0;
00463   <span class="keywordtype">int</span> nactiveladders = <a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>.size();
00464   <span class="keywordflow">for</span> ( <a class="code" href="classTrRecon.html#x0">ITClusterMap</a> lad=<a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>.begin();lad!=<a class="code" href="classTrRecon.html#p2">_ClusterTkIdMap</a>.end();lad++){
00465     <span class="keywordtype">int</span> tkid = lad-&gt;first;
00466     <span class="keywordtype">int</span> nx   = lad-&gt;second.first.size();
00467     <span class="keywordtype">int</span> ny   = lad-&gt;second.second.size();
00468 
00469     <span class="comment">/*</span>
00470 <span class="comment">    // "ghost" hits</span>
00471 <span class="comment">    for (int ix=0; ix&lt;nx; ix++) {</span>
00472 <span class="comment">    if (ThrProb&gt;0.) continue;  </span>
00473 <span class="comment">    AMSTrRecHit* hit = new AMSTrRecHit(tkid,GetTrCluster(tkid,0,ix),0,-1.,0.,1);</span>
00474 <span class="comment">    GetEvent()-&gt;AddTrRecHit(hit);     </span>
00475 <span class="comment">    ntrrechits++;</span>
00476 <span class="comment">    }</span>
00477 <span class="comment">    for (int iy=0; iy&lt;ny; iy++) {</span>
00478 <span class="comment">    if (ThrProb&gt;0.) continue;  </span>
00479 <span class="comment">       AMSTrRecHit* hit = new AMSTrRecHit(tkid,0,GetTrCluster(tkid,1,iy),1.,0.,1);</span>
00480 <span class="comment">       GetEvent()-&gt;AddTrRecHit(hit);     </span>
00481 <span class="comment">       ntrrechits++;</span>
00482 <span class="comment">       }</span>
00483 <span class="comment">    */</span>
00484 
00485     <span class="comment">// all combinations</span>
00486     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ix=0; ix&lt;nx; ix++) {
00487       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iy=0; iy&lt;ny; iy++) {
00488         <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* clX = lad-&gt;second.first.at(ix);
00489         <a class="code" href="classAMSTrCluster.html">AMSTrCluster</a>* clY = lad-&gt;second.second.at(iy);
00490         <span class="keywordtype">float</span>     corr = <a class="code" href="classTrRecon.html#a15">GetCorrelation</a>(clX,clY);
00491         <span class="keywordtype">float</span>     prob = <a class="code" href="classTrRecon.html#a17">GetProbToBeCorrelated</a>(clX,clY);
00492         <span class="comment">// the hit must have a minimum required probability (???)</span>
00493         <span class="keywordflow">if</span> (prob&lt;ThrProb) <span class="keywordflow">continue</span>;  
00494         <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a>* hit = <span class="keyword">new</span> <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a>(tkid,clX,clY,corr,prob,0);
00495         cont2-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(hit);
00496         <span class="comment">//      hit-&gt;Print();</span>
00497         ntrrechits++;
00498       }
00499     }    
00500   }
00501   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00502   <span class="keywordflow">if</span>(cont2) <span class="keyword">delete</span> cont2;
00503 
00504   <span class="keywordflow">return</span> ntrrechits;
00505 } 
00506 
00507 
00509 <span class="comment">// --- TRACKS --- //</span>
00511 <span class="comment"></span>
<a name="l00512"></a><a class="code" href="classTrRecon.html#t0">00512</a> <span class="keywordtype">double</span> TrRecon::_csqmin;
<a name="l00513"></a><a class="code" href="classTrRecon.html#t1">00513</a> <span class="keywordtype">int</span>    <a class="code" href="classTrRecon.html#t1">TrRecon::NHitPatterns</a>     = 0;
<a name="l00514"></a><a class="code" href="classTrRecon.html#t2">00514</a> <span class="keywordtype">int</span>   *<a class="code" href="classTrRecon.html#t2">TrRecon::HitPatternMask</a>   = 0;
<a name="l00515"></a><a class="code" href="classTrRecon.html#t3">00515</a> <span class="keywordtype">int</span>   *<a class="code" href="classTrRecon.html#t3">TrRecon::HitPatternAttrib</a> = 0;
00516 
<a name="l00517"></a><a class="code" href="classTrRecon.html#a28">00517</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a28">TrRecon::BuildRecHitLayerMap</a>() {
00518   <a class="code" href="classTrRecon.html#p3">_RecHitLayerMap</a>.clear();
00519 
00520   <a class="code" href="classVCon.html">VCon</a>* cont = <a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrRecHit"</span>);
00521   <span class="keywordflow">if</span>(!cont){
00522     printf(<span class="stringliteral">"TrRecon::BuildRecHitLayerMap:  "</span>
00523            <span class="stringliteral">"Cant Find AMSTrRecHit Container\n"</span>);
00524     <span class="keywordflow">return</span>;
00525   }
00526 
00527   <span class="comment">// loop on TrRecHit</span>
00528   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=0;ii&lt;cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>();ii++){
00529     <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a>* hit = (<a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a>*)cont-&gt;<a class="code" href="classVCon.html#a5">getelem</a>(ii);
00530     <span class="keywordtype">int</span> lay = hit-&gt;<a class="code" href="classAMSTrRecHit.html#a7">GetLayer</a>();
00531     <a class="code" href="classTrRecon.html#p3">_RecHitLayerMap</a>[lay].push_back(hit);
00532   }
00533 
00534   <span class="keyword">delete</span> cont;
00535 }
00536 
<a name="l00537"></a><a class="code" href="classTrRecon.html#a24">00537</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a24">TrRecon::BuildHitPatterns</a>(<span class="keywordtype">int</span> n, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> mask)
00538 {
00539   <span class="keyword">static</span> <span class="keywordtype">int</span> PatternID = 0;
00540 
00541   <span class="comment">// Build all the patterns (starting point)</span>
00542   <span class="keywordflow">if</span> (n &lt; 0) {
00543     <a class="code" href="classTrRecon.html#t1">NHitPatterns</a> = 256 -1 -8 -8*7/2; <span class="comment">// = 219 (Nhit &gt;= 3)</span>
00544     <span class="keywordflow">if</span> (!HitPatternMask)   <a class="code" href="classTrRecon.html#t2">HitPatternMask</a>   = <span class="keyword">new</span> <span class="keywordtype">int</span>[NHitPatterns];
00545     <span class="keywordflow">if</span> (!HitPatternAttrib) <a class="code" href="classTrRecon.html#t3">HitPatternAttrib</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[NHitPatterns];
00546     PatternID = 0;
00547     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 6; j++) <a class="code" href="classTrRecon.html#a24">BuildHitPatterns</a>(j);
00548     <span class="keywordflow">return</span>;
00549   }
00550 
00551   <span class="comment">// Build pattern mask bits recursively with n hits masked</span>
00552   <span class="keywordtype">int</span> maskbit[8] = { 1, 3, 5, 2, 4, 6, 0, 7 };
00553   <span class="keywordflow">if</span> (n &gt; 0) {
00554     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = i; j &lt; MAXLAY; j++)
00555       <a class="code" href="classTrRecon.html#a24">BuildHitPatterns</a>(n-1, j+1, mask | (1&lt;&lt;maskbit[j]));
00556     <span class="keywordflow">return</span>;
00557   }
00558 
00559   <span class="comment">// Check pattern attribute ( = N1*10000 +N2*1000 +N3*100 +N4*10 +N5)</span>
00560   <span class="keywordtype">int</span> atrb = 12221, nmask = 0, iatrb = 10000;
00561   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; MAXLAY; i++) {
00562     <span class="keywordflow">if</span> (i%2 == 1) iatrb /= 10;
00563     <span class="keywordflow">if</span> (mask &amp; (1&lt;&lt;i)) { atrb -= iatrb; nmask++; }
00564   }
00565   <a class="code" href="classTrRecon.html#t2">HitPatternMask</a>  [PatternID] = mask;
00566   <a class="code" href="classTrRecon.html#t3">HitPatternAttrib</a>[PatternID] = atrb;
00567 
00568   <span class="comment">// Not allowed (1): Both external layers are masked</span>
00569   <span class="keywordflow">if</span> (atrb/10000 == 0 &amp;&amp; atrb%10 == 0) <a class="code" href="classTrRecon.html#t3">HitPatternAttrib</a>[PatternID] = -atrb;
00570 
00571   <span class="comment">// Not allowed (2): Both layers on any of internal planes are masked</span>
00572   <span class="keywordflow">if</span> ((atrb/1000)%10 == 0 || (atrb/100)%10 == 0 || (atrb/10)%10 == 0)
00573     <a class="code" href="classTrRecon.html#t3">HitPatternAttrib</a>[PatternID] = -atrb;
00574 
00575   <span class="comment">// Not allowed (3): Any external layers are masked and Nmask &gt;= 3</span>
00576   <span class="keywordflow">if</span> (nmask &gt;= 3 &amp;&amp; (atrb/10000 == 0 || atrb%10 == 0))
00577     <a class="code" href="classTrRecon.html#t3">HitPatternAttrib</a>[PatternID] = -atrb;
00578 
00579   PatternID++;
00580 }
00581 
00582 <span class="keywordtype">int</span> <a class="code" href="classTrRecon.html#a27">TrRecon::BuildTrTracks</a>(<span class="keywordtype">int</span> rebuild)
00583 {
00584   <a class="code" href="classVCon.html">VCon</a>* cont = TRCon-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrTrack"</span>);
00585   <span class="keywordflow">if</span>(!cont){
00586     printf(<span class="stringliteral">"TrRecon::BuildTrTrack  "</span>
00587            <span class="stringliteral">"Cant Find AMSTrTrack Container\n"</span>);
00588     <span class="keywordflow">return</span> -1;
00589   }
00590 
00591   <span class="comment">// Build hit patterns if not yet built</span>
00592   <span class="keywordflow">if</span> (!HitPatternMask) <a class="code" href="classTrRecon.html#a24">BuildHitPatterns</a>();
00593 
00594   <span class="comment">// Build a map for the hits layer</span>
00595   <a class="code" href="classTrRecon.html#a28">BuildRecHitLayerMap</a>();
00596 
00597   <a class="code" href="classTrRecon.html#p0">_ptest</a> = <span class="keyword">new</span> <a class="code" href="classAMSTrTrack.html">AMSTrTrack</a>();
00598 
00599   <span class="keywordtype">int</span> ntrack = 0;
00600   <span class="keywordflow">while</span> (ntrack &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxNtrack) {
00601     <a class="code" href="classTrRecon.html#t0">_csqmin</a> = <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0];
00602     <a class="code" href="classTrRecon.html#p1">_ptrack</a> = 0;
00603 
00604     <span class="comment">// Scan track with each hit pattern</span>
00605     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTrRecon.html#t1">NHitPatterns</a> &amp;&amp; !_ptrack; i++) {
00606       <span class="comment">// Skip if the pattern is not allowed</span>
00607       <span class="keywordflow">if</span> (!<a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.patternp02[i] &amp;&amp; <a class="code" href="classTrRecon.html#t3">HitPatternAttrib</a>[i] &lt; 0) <span class="keywordflow">continue</span>;
00608 
00609       <span class="comment">// Make a pattern vector: layer[]</span>
00610       <span class="keywordtype">int</span> layer[MAXLAY], nlyr = 0;
00611       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; MAXLAY; j++)
00612         <span class="keywordflow">if</span> (!(<a class="code" href="classTrRecon.html#t2">HitPatternMask</a>[i] &amp; (1&lt;&lt;j))) layer[nlyr++] = j;
00613 
00614       <span class="keywordflow">if</span> (nlyr &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MinNhit) <span class="keywordflow">break</span>;
00615 
00616       <span class="comment">// Scan hits</span>
00617       <span class="keywordtype">int</span> iscan[MAXLAY], imult[MAXLAY];
00618       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nlyr;
00619       <a class="code" href="classTrRecon.html#a29">ScanHit</a>(layer, iscan, imult);
00620     }
00621 
00622     <span class="comment">// Add a new track if found</span>
00623     <span class="keywordflow">if</span> (_ptrack) {
00624       <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a34">Fit</a>(0);
00625       cont-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(_ptrack);
00626       
00627       <span class="comment">// Mark hits as USED</span>
00628       <span class="keywordtype">int</span> nhits = <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a11">GetNhits</a>();
00629       <span class="comment">// Build the index table</span>
00630       <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a6">BuildHitsIndex</a>();
00631       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nhits; i++) {
00632         <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a> *phit = <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(i);
00633         <span class="keywordflow">if</span> (phit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a>&amp;USED) phit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a> |= AMBIG;
00634         <span class="keywordflow">else</span> phit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a> |= USED;
00635 
00636         <span class="comment">// Set multiplicity index</span>
00637         <span class="keywordflow">if</span> (phit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a> &lt; 0) phit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a> = <a class="code" href="classTrRecon.html#p1">_ptrack</a>-&gt;<a class="code" href="classAMSTrTrack.html#o2">_iMult</a>[i];
00638       }
00639       ntrack++;
00640       <span class="comment">//      _ptrack-&gt;myprint();</span>
00641       <a class="code" href="classTrRecon.html#p1">_ptrack</a> = 0;
00642     }
00643 
00644     <span class="comment">// Break if no track found</span>
00645     <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
00646   }
00647 
00648   <span class="keyword">delete</span> cont;
00649   <span class="keyword">delete</span> _ptest;
00650 
00651   <span class="keywordflow">return</span> ntrack;
00652 }
00653 
00654 
00655 <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#a29">TrRecon::ScanHit</a>(<span class="keywordtype">int</span> *layer, <span class="keywordtype">int</span> *iscan, <span class="keywordtype">int</span> *imult, <span class="keywordtype">int</span> i)
00656 {
00657   <span class="comment">// Clear hits vector</span>
00658   <span class="keywordflow">if</span> (i == 0) <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; MAXLAY; j++) <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o0">_Hits</a>[j] = 0;
00659 
00660   <span class="keywordtype">int</span> nhits = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a>;
00661 
00662   <span class="comment">// Evaluate a track</span>
00663   <span class="keywordflow">if</span> (i == nhits) {
00664 
00665     <span class="comment">// Ambiguity check</span>
00666     <span class="keywordflow">if</span> (layer[0] != 0 &amp;&amp; layer[nhits-1] != MAXLAY-1) <span class="keywordflow">return</span>;
00667 
00668     <span class="comment">// Fit and check chisquare</span>
00669     <span class="keywordflow">if</span> (<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>() &lt; <a class="code" href="classTrRecon.html#t0">_csqmin</a> &amp;&amp; <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a34">Fit</a>(0) &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[1]) {
00670 
00671       <span class="comment">// Replace the track candidate</span>
00672       <span class="keywordflow">if</span> (!_ptrack) <a class="code" href="classTrRecon.html#p1">_ptrack</a> = <span class="keyword">new</span> <a class="code" href="classAMSTrTrack.html">AMSTrTrack</a>;
00673       *<a class="code" href="classTrRecon.html#p1">_ptrack</a> = *_ptest;
00674       <a class="code" href="classTrRecon.html#t0">_csqmin</a> = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a29">GetChisqWoMS</a>();
00675     }
00676 
00677     <span class="keywordflow">return</span>;
00678   }
00679 
00680   <span class="comment">// Loop for each hit in the layer</span>
00681   
00682   <span class="keywordtype">int</span> nscan = <a class="code" href="classTrRecon.html#p3">_RecHitLayerMap</a>[layer[i]+1].size();
00683   <span class="keywordflow">for</span> (iscan[i] = 0; iscan[i] &lt; nscan; iscan[i]++) {
00684 
00685     <span class="comment">// Get and check a hit</span>
00686     <a class="code" href="classAMSTrRecHit.html">AMSTrRecHit</a> *hit = <a class="code" href="classTrRecon.html#p3">_RecHitLayerMap</a>[layer[i]+1].at(iscan[i]);
00687     <span class="keywordflow">if</span> (hit-&gt;<a class="code" href="classAMSTrRecHit.html#a7">GetLayer</a>() != layer[i]+1) <span class="keywordflow">continue</span>;
00688     <span class="keywordflow">if</span> ((hit-&gt;<a class="code" href="classAMSTrRecHit.html#o3">_status</a>&amp;USED) &amp;&amp; hit-&gt;<a class="code" href="classAMSTrRecHit.html#a7">GetLayer</a>() &gt; 2) <span class="keywordflow">continue</span>;
00689     <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o0">_Hits</a>[i] = hit;
00690     <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o2">_iMult</a>[i] = 0;
00691 
00692     <span class="comment">// Optimization only for non-B run: Check with only Y-side</span>
00693     <span class="keywordflow">if</span> (MAGFIELDFFKEY.magstat == 0 &amp;&amp; i &gt;= 2) {
00694       <span class="keywordtype">double</span> err[3] = { 0, 0.03, 0.03 };
00695 
00696       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = i+1;
00697       <span class="keywordtype">double</span> csq = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>(err);
00698       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nhits;
00699       <span class="keywordflow">if</span> (csq &gt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0]) <span class="keywordflow">continue</span>;
00700     }
00701 
00702     <span class="keywordtype">int</span> nmult = hit-&gt;<a class="code" href="classAMSTrRecHit.html#a14">GetMultiplicity</a>(), im0 = 0;
00703 
00704     <span class="comment">// Fix multiplicity index if already determined</span>
00705     <span class="keywordflow">if</span> (hit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a> &gt;= 0) { 
00706       im0 = hit-&gt;<a class="code" href="classAMSTrRecHit.html#o5">_imult</a>; 
00707       nmult = im0+1; 
00708     }
00709 
00710     <span class="comment">// Tighten multiplicity range if the previous layer is on the same plane</span>
00711     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &gt; 0 &amp;&amp; 
00712              (layer[i-1] == 1 || layer[i-1] == 3 || layer[i-1] == 5) &amp;&amp;
00713              layer[i-1]+1 == layer[i]) {
00714       im0   = std::max(imult[i-1]-1, 0);
00715       nmult = std::min(imult[i-1]+2, hit-&gt;<a class="code" href="classAMSTrRecHit.html#a14">GetMultiplicity</a>());
00716     }
00717 
00718     <span class="comment">// Loop for each multiplicity</span>
00719     <span class="keywordflow">for</span> (imult[i] = im0; imult[i] &lt; nmult; imult[i]++) {
00720 
00721       <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o2">_iMult</a>[i] = imult[i];
00722 
00723       <span class="comment">// Optimization only for non-B run: Check with only X-side</span>
00724       <span class="keywordflow">if</span> (MAGFIELDFFKEY.magstat == 0 &amp;&amp; i &gt;= 2) {
00725         <span class="keywordtype">double</span> err[3] = { 0.03, 0, 0.03 };
00726 
00727         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = i+1;
00728         <span class="keywordtype">double</span> csq = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>(err);
00729         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nhits;
00730         <span class="keywordflow">if</span> (csq &gt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0]) <span class="keywordflow">continue</span>;
00731       }
00732 
00733       <span class="keywordflow">else</span> {
00734 
00735       <span class="comment">// Make a quick check parameter</span>
00736       <span class="keywordflow">if</span> (i == 2) {
00737         AMSPoint x0 = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(0)-&gt;<a class="code" href="classAMSTrRecHit.html#a15">GetCoord</a>(imult[0]);
00738         AMSPoint x2 = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(2)-&gt;<a class="code" href="classAMSTrRecHit.html#a15">GetCoord</a>(imult[2]);
00739 
00740         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0] = (x2[0]-x0[0])/(x2[2]-x0[2]);
00741         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0] = (x2[1]-x0[1])/(x2[2]-x0[2]);
00742         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][1] =  x0[0]-<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]*x0[2];
00743         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][1] =  x0[1]-<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]*x0[2];
00744         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][2] = sqrt(1+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]*<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]);
00745         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][2] = sqrt(1+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]*<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]);
00746       }
00747 
00748       <span class="comment">// Quick check</span>
00749       <span class="keywordflow">if</span> (i &gt;= 2) {
00750         <span class="keywordtype">int</span> l = (i == 2) ? 1 : i;
00751         AMSPoint x1 = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a27">GetHit</a>(l)-&gt;<a class="code" href="classAMSTrRecHit.html#a15">GetCoord</a>(imult[l]);
00752 
00753         <span class="keywordflow">if</span> ( !(fabs(<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][1]+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][0]*x1[2]-x1[0]) 
00754                &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.SearchRegStrLine*<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[0][2] &amp;&amp;
00755                fabs(<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][1]+<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][0]*x1[2]-x1[1]) 
00756                &lt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.SearchRegCircle *<a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o38">_Par</a>[1][2]) ) <span class="keywordflow">continue</span>;
00757 
00758         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = i+1;
00759         <span class="keywordtype">double</span> csq = <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#a32">SimpleFit</a>();
00760         <a class="code" href="classTrRecon.html#p0">_ptest</a>-&gt;<a class="code" href="classAMSTrTrack.html#o4">_Nhits</a> = nhits;
00761         <span class="keywordflow">if</span> (csq &gt; <a class="code" href="tkdcards_8h.html#a6">TRFITFFKEY</a>.MaxChisq[0]) <span class="keywordflow">continue</span>;
00762       }
00763 
00764       }
00765 
00766       <span class="comment">// Go to the next layer</span>
00767       <a class="code" href="classTrRecon.html#a29">ScanHit</a>(layer, iscan, imult, i+1);
00768     }
00769   }
00770 }
00771 
00772 <span class="comment">//=========================================================================</span>
00773 <span class="comment">// #####################################</span>
00774 <span class="comment">// #             MC HITS               #</span>
00775 <span class="comment">// #####################################</span>
00776 
00777 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">double</span> <a class="code" href="TrDigi_8C.html#a0">rnormx</a>();
00778 
00779 
<a name="l00780"></a><a class="code" href="classTrRecon.html#e3">00780</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#e3">TrRecon::sitkhits</a>(<span class="keywordtype">int</span> idsoft, <span class="keywordtype">float</span> vect[],
00781                            <span class="keywordtype">float</span> edep, <span class="keywordtype">float</span> step, <span class="keywordtype">int</span> itra)
00782 {
00783   AMSPoint ppa (vect[0],vect[1],vect[2]);
00784   AMSPoint dirg(vect[3],vect[4],vect[5]);
00785   AMSPoint pmom(vect[3]*vect[6], vect[4]*vect[6], vect[5]*vect[6]);
00786   AMSPoint ppb = ppa-dirg*step;
00787   AMSPoint pgl = ppa-dirg*step/2;
00788   
00789   AMSPoint size(TkDBc::Head-&gt;_ssize_active[0]/2,
00790                 TkDBc::Head-&gt;_ssize_active[1]/2,
00791                 TkDBc::Head-&gt;_silicon_z/2);
00792   <span class="comment">//  XXPLSS  |XX=sensor|P 0 neg 1 pos |L=layer |SS=slot|</span>
00793   <span class="keywordtype">int</span> sensor = abs(idsoft)/10000;
00794   <span class="keywordtype">int</span> tkid   = abs(idsoft)%1000;
00795   <span class="keywordtype">int</span> ss     = abs(idsoft)%10000-tkid;
00796   <span class="keywordflow">if</span>(!ss) tkid*=-1;
00797   <span class="comment">// Convert global coo into sensor local coo</span>
00798   <span class="comment">// The origin is the first strip of the sensor</span>
00799   <a class="code" href="classTkSens.html">TkSens</a> tksa(tkid, ppa);
00800   <a class="code" href="classTkSens.html">TkSens</a> tksb(tkid, ppb);
00801   AMSPoint pa = tksa.<a class="code" href="classTkSens.html#a10">GetSensCoo</a>(); pa[2] += size[2];
00802   AMSPoint pb = tksb.<a class="code" href="classTkSens.html#a10">GetSensCoo</a>(); pb[2] += size[2];
00803 
00804   <span class="comment">// Range check</span>
00805   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; i++) {
00806     <span class="keywordflow">if</span> (pa[i] &lt; 0) pa[i] = 0;
00807     <span class="keywordflow">if</span> (pb[i] &lt; 0) pb[i] = 0;
00808     <span class="keywordflow">if</span> (pa[i] &gt; 2*size[i]) pa[i] = 2*size[i];
00809     <span class="keywordflow">if</span> (pb[i] &gt; 2*size[i]) pb[i] = 2*size[i];
00810   }
00811   
00812   <span class="comment">// Create a new object</span>
00813   <a class="code" href="classVCon.html">VCon</a>* aa=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrMCCluster"</span>);
00814   <span class="keywordflow">if</span>(aa)
00815     aa-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(  <span class="keyword">new</span> <a class="code" href="classAMSTrMCCluster.html">AMSTrMCCluster</a>(idsoft, pa, pb, pgl,pmom,edep , itra));
00816   <span class="keywordflow">if</span>(aa) <span class="keyword">delete</span> aa;
00817 }
00818 
00819 
00820 
<a name="l00821"></a><a class="code" href="classTrRecon.html#e5">00821</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#e5">TrRecon::sitkdigi</a>()
00822 {
00823   <span class="comment">//Get the pointer to the TrMCCluster container</span>
00824   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrMCCluster"</span>);
00825   <span class="keywordflow">if</span>(!cont){
00826     printf(<span class="stringliteral">"TrSim::sitkdigi()  Cant Find AMSMCCluster Container Digitization is Impossible !!!\n"</span>);
00827     return ;
00828   }
00829   <span class="keywordflow">if</span>(cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>()==0){
00830     printf(<span class="stringliteral">"TrSim::sitkdigi()  AMSTrMCCluster Container is Empty  Digitzation is Impossible !!!\n"</span>);
00831     return ;
00832   }<span class="keywordflow">else</span>
00833     printf(<span class="stringliteral">"TrSim::sitkdigi()  AMSTrMCCluster Container has %d elements \n"</span>,cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>());
00834   <span class="comment">//Create the map of TrMCClusters</span>
00835   <a class="code" href="classTrMap.html">TrMap&lt;AMSTrMCCluster&gt;</a> MCClMap;
00836   
00837   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=0;ii&lt;cont-&gt;<a class="code" href="classVCon.html#a3">getnelem</a>();ii++){
00838     <a class="code" href="classAMSTrMCCluster.html">AMSTrMCCluster</a>* clu=(<a class="code" href="classAMSTrMCCluster.html">AMSTrMCCluster</a>*)cont-&gt;<a class="code" href="classVCon.html#a5">getelem</a>(ii);
00839     <span class="keywordflow">if</span> (clu)MCClMap.<a class="code" href="classTrMap.html#a3">Add</a>(clu);
00840     <span class="comment">//clu-&gt;_printEl(cerr); </span>
00841   }
00842 
00843   <span class="comment">//LOOP ON ALL THE LADDERS</span>
00844   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> lay=1;lay&lt;=trconst::nlays;lay++){
00845     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> slot=1;slot&lt;=trconst::maxlad;slot++){
00846       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> side=-1;side&lt;2;side=side+2){
00847         <span class="keywordtype">int</span> tkid=(lay*100+slot)*side;
00848         <span class="keywordflow">if</span>(!TkDBc::Head-&gt;<a class="code" href="classTkDBc.html#a22">FindTkId</a>(tkid)) continue  ;
00849         
00850         <a class="code" href="classTrLadCal.html">TrLadCal</a> *tcal = TrCalDB::Head-&gt;<a class="code" href="classTrCalDB.html#a10">FindCal_TkId</a>(tkid);
00851         <span class="keywordflow">if</span> (!tcal) {
00852           std::cerr &lt;&lt; <span class="stringliteral">"ERROR(1) tcal not found: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00853           <span class="keywordflow">continue</span>;
00854         }
00855         <span class="comment">//      printf("Ladder %+03d Has been selected\n",tkid);</span>
00856         geant* buf=<span class="keyword">new</span> geant[1024];
00857         <span class="comment">//Expand the noise</span>
00858         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=0;ii&lt;1024;ii++){
00859           <span class="keywordflow">if</span>(tcal-&gt;<a class="code" href="classTrLadCal.html#a8">Status</a>(ii)&amp;TrLadCal::dead)
00860             buf[ii]=-1000;
00861           <span class="keywordflow">else</span>
00862             buf[ii]= tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii)*<a class="code" href="TrDigi_8C.html#a0">rnormx</a>();
00863           <span class="comment">// printf("%4d: %6.2f ",ii, buf[ii]);</span>
00864         }
00865         <span class="comment">//expand the TrMCClusters</span>
00866         <span class="comment">//      printf("\n");</span>
00867 
00868         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> icl=0;icl&lt;MCClMap.<a class="code" href="classTrMap.html#a4">GetNelem</a>(tkid);icl++){
00869           <a class="code" href="classAMSTrMCCluster.html">AMSTrMCCluster</a>* cl=MCClMap.<a class="code" href="classTrMap.html#a5">GetElem</a>(tkid,icl);
00870 
00871           <span class="keywordtype">int</span> addK=cl-&gt;<a class="code" href="classAMSTrMCCluster.html#a1">GetAdd</a>(0);
00872           <span class="comment">// printf("ClusterK: ");</span>
00873           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=0;jj&lt;cl-&gt;<a class="code" href="classAMSTrMCCluster.html#a2">GetSize</a>(0);jj++){
00874             buf[addK+jj] += cl-&gt;<a class="code" href="classAMSTrMCCluster.html#a3">GetSignal</a>(jj,0)*10.;
00875             <span class="comment">//  printf(" %4d: %6.2f",addK+jj,cl-&gt;GetSignal(jj,0));</span>
00876           }
00877           <span class="comment">//       printf("\n");</span>
00878           <span class="keywordtype">int</span> addS=cl-&gt;<a class="code" href="classAMSTrMCCluster.html#a1">GetAdd</a>(1);
00879           <span class="comment">//printf("ClusterS: ");</span>
00880           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=0;jj&lt;cl-&gt;<a class="code" href="classAMSTrMCCluster.html#a2">GetSize</a>(1);jj++){
00881             buf[addS+jj] += cl-&gt;<a class="code" href="classAMSTrMCCluster.html#a3">GetSignal</a>(jj,1)*10.;
00882             <span class="comment">// printf(" %4d: %6.2f",addS+jj,cl-&gt;GetSignal(jj,1));</span>
00883           }
00884           <span class="comment">//printf("\n");</span>
00885           <span class="comment">//      printf("Ladder %+03d Has been selected\n",tkid);</span>
00886         }
00887         
00888         <span class="comment">// Do clusterization the DSP way</span>
00889 
00890         <a class="code" href="classTrRecon.html#h0">DSP_Clusterize</a>(tkid,buf);
00891 
00892         <span class="keyword">delete</span> [] buf;
00893       }
00894 
00895     }
00896   }
00897   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00898   <span class="keywordflow">return</span>;
00899 }
00900 
00901 
<a name="l00902"></a><a class="code" href="classTrRecon.html#h0">00902</a> <span class="keywordtype">void</span> <a class="code" href="classTrRecon.html#h0">TrRecon::DSP_Clusterize</a>(<span class="keywordtype">int</span> tkid,<span class="keywordtype">float</span> *buf){
00903 
00904   <span class="comment">//Get the pointer to the TrMCCluster container</span>
00905   <a class="code" href="classVCon.html">VCon</a>* cont=<a class="code" href="classTrRecon.html#s7">TRCon</a>-&gt;<a class="code" href="classVCon.html#a2">GetCont</a>(<span class="stringliteral">"AMSTrRawCluster"</span>);
00906   <span class="keywordflow">if</span>(!cont){
00907     printf(<span class="stringliteral">"TrRecon::DSP_Clusterize  Cant Find AMSTrRawCluster Container Digitization is Impossible !!!\n"</span>);
00908     return ;
00909   }
00910 
00911 
00912   <a class="code" href="classTrLadCal.html">TrLadCal</a> *tcal = TrCalDB::Head-&gt;<a class="code" href="classTrCalDB.html#a10">FindCal_TkId</a>(tkid);
00913   <span class="keywordflow">if</span> (!tcal) {
00914     std::cerr &lt;&lt; <span class="stringliteral">"TrRecon::DSP_Clusterize ERROR(1) tcal not found: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00915     std::cerr &lt;&lt; <span class="stringliteral">"Clusterization aborted for ladder "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00916     <span class="keywordflow">return</span>;
00917   }
00918   
00919   <span class="keywordflow">if</span>(!buf){
00920     std::cerr &lt;&lt; <span class="stringliteral">"TrRecon::DSP_Clusterize Buffer not available: "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00921     std::cerr &lt;&lt; <span class="stringliteral">"Clusterization aborted for ladder "</span> &lt;&lt; tkid &lt;&lt; std::endl;
00922     <span class="keywordflow">return</span>;
00923   }
00924   <span class="keywordtype">int</span> used[1024];
00925   memset(used,0,1024*<span class="keyword">sizeof</span>(used[0]));
00926 
00927   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=0;ii&lt;639;ii++){
00928 <span class="comment">//     printf("%4d: used: %d st: %4d S: %6.2f N: %6.2f  SN: %6.2f \n",</span>
00929 <span class="comment">//         ii,used[ii],tcal-&gt;Status(ii),buf[ii],tcal-&gt;Sigma(ii),buf[ii]/tcal-&gt;Sigma(ii)</span>
00930 <span class="comment">//         );</span>
00931     <span class="keywordflow">if</span>(used[ii]!=0) <span class="keywordflow">continue</span>;
00932     <span class="keywordflow">if</span>(tcal-&gt;<a class="code" href="classTrLadCal.html#a8">Status</a>(ii)!=0) <span class="keywordflow">continue</span>;
00933     <span class="keywordflow">if</span>(buf[ii]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii)&lt;=<a class="code" href="tkdcards_8h.html#a2">TRMCFFKEY</a>.th1sim[0]) <span class="keywordflow">continue</span>;
00934     <span class="keywordflow">if</span>(buf[ii+1]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii+1)&gt;buf[ii]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii) ) <span class="keywordflow">continue</span>;
00935     <span class="comment">//SEED found</span>
00936     <span class="comment">//    printf("SEED %d \n",tkid);</span>
00937     <span class="keywordtype">int</span> seed=ii;
00938     used[ii]=1;
00939     <span class="keywordtype">int</span> left=0;
00940     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=seed-1;jj&gt;=0;jj--)
00941       <span class="keywordflow">if</span>(((buf[jj]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(jj))&gt;<a class="code" href="tkdcards_8h.html#a2">TRMCFFKEY</a>.th2sim[0])&amp;&amp; used[jj]==0){
00942         used[jj]=1;
00943         left=jj;
00944       }
00945     
00946     <span class="keywordtype">int</span> right=639;
00947     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=seed+1;jj&lt;640;jj++)
00948       <span class="keywordflow">if</span>(((buf[jj]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(jj))&gt;<a class="code" href="tkdcards_8h.html#a2">TRMCFFKEY</a>.th2sim[0]) &amp;&amp; used[jj]==0){
00949         used[jj]=1;
00950         right=jj;
00951       }
00952     <span class="keywordflow">if</span>(left&gt;0) left--;
00953     <span class="keywordflow">if</span>(right&lt;639) right++;
00954     <span class="comment">//printf("LEFT:  %3d  RIGHT:  %3d \n",left,right);</span>
00955     <span class="comment">//    printf("Adding Raw Clus: %d\n",tkid);</span>
00956     cont-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(<span class="keyword">new</span> <a class="code" href="classAMSTrRawCluster.html">AMSTrRawCluster</a>(tkid, left, right-left+1, &amp;(buf[left])));
00957   }
00958 
00959 
00960   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=640;ii&lt;1024;ii++){
00961 
00962     <span class="keywordflow">if</span>(used[ii]!=0) <span class="keywordflow">continue</span>;
00963     <span class="keywordflow">if</span>(tcal-&gt;<a class="code" href="classTrLadCal.html#a8">Status</a>(ii)!=0) <span class="keywordflow">continue</span>;
00964     <span class="keywordflow">if</span>(buf[ii]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii)&lt;=<a class="code" href="tkdcards_8h.html#a2">TRMCFFKEY</a>.th1sim[1]) <span class="keywordflow">continue</span>;
00965     <span class="keywordflow">if</span>(buf[ii+1]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii+1)&gt;buf[ii]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(ii) ) <span class="keywordflow">continue</span>;
00966     <span class="comment">//SEED found</span>
00967     <span class="keywordtype">int</span> seed=ii;
00968     used[ii]=1;
00969     <span class="keywordtype">int</span> left=640;
00970     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=seed-1;jj&gt;=640;jj--)
00971       <span class="keywordflow">if</span>(((buf[jj]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(jj))&gt;<a class="code" href="tkdcards_8h.html#a2">TRMCFFKEY</a>.th2sim[1])&amp;&amp; used[jj]==0){
00972         used[jj]=1;
00973         left=jj;
00974       }    
00975     <span class="keywordtype">int</span> right=1023;
00976     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=seed+1;jj&lt;1024;jj++)
00977       <span class="keywordflow">if</span>(((buf[jj]/tcal-&gt;<a class="code" href="classTrLadCal.html#a6">Sigma</a>(jj))&gt;<a class="code" href="tkdcards_8h.html#a2">TRMCFFKEY</a>.th2sim[1])&amp;&amp; used[jj]==0){
00978         used[jj]=1;
00979         right=jj;
00980       }
00981     
00982     cont-&gt;<a class="code" href="classVCon.html#a7">addnext</a>(<span class="keyword">new</span> <a class="code" href="classAMSTrRawCluster.html">AMSTrRawCluster</a>(tkid, left, right-left+1, &amp;(buf[left])));
00983   }
00984   <span class="keywordflow">if</span>(cont) <span class="keyword">delete</span> cont;
00985 
00986 }
00987 
00988 
00989 <span class="comment">/*</span>
00990 <span class="comment">Tracker hit pattern list</span>
00991 <span class="comment"></span>
00992 <span class="comment">PatID Nhits   Pattern  Sw Attrib</span>
00993 <span class="comment">    0     8  11111111   1  12221</span>
00994 <span class="comment"></span>
00995 <span class="comment">    1     7  10111111   1  11221</span>
00996 <span class="comment">    2     7  11101111   1  12121</span>
00997 <span class="comment">    3     7  11111011   1  12211</span>
00998 <span class="comment">    4     7  11011111   1  11221</span>
00999 <span class="comment">    5     7  11110111   1  12121</span>
01000 <span class="comment">    6     7  11111101   1  12211</span>
01001 <span class="comment">    7     7  01111111   1  02221</span>
01002 <span class="comment">    8     7  11111110   1  12220</span>
01003 <span class="comment"></span>
01004 <span class="comment">    9     6  10101111   1  11121</span>
01005 <span class="comment">   10     6  10111011   1  11211</span>
01006 <span class="comment">   11     6  10011111   0  10221</span>
01007 <span class="comment">   12     6  10110111   1  11121</span>
01008 <span class="comment">   13     6  10111101   1  11211</span>
01009 <span class="comment">   14     6  00111111   1  01221</span>
01010 <span class="comment">   15     6  10111110   1  11220</span>
01011 <span class="comment">   16     6  11101011   1  12111</span>
01012 <span class="comment">   17     6  11001111   1  11121</span>
01013 <span class="comment">   18     6  11100111   0  12021</span>
01014 <span class="comment">   19     6  11101101   1  12111</span>
01015 <span class="comment">   20     6  01101111   1  02121</span>
01016 <span class="comment">   21     6  11101110   1  12120</span>
01017 <span class="comment">   22     6  11011011   1  11211</span>
01018 <span class="comment">   23     6  11110011   1  12111</span>
01019 <span class="comment">   24     6  11111001   0  12201</span>
01020 <span class="comment">   25     6  01111011   1  02211</span>
01021 <span class="comment">   26     6  11111010   1  12210</span>
01022 <span class="comment">   27     6  11010111   1  11121</span>
01023 <span class="comment">   28     6  11011101   1  11211</span>
01024 <span class="comment">   29     6  01011111   1  01221</span>
01025 <span class="comment">   30     6  11011110   1  11220</span>
01026 <span class="comment">   31     6  11110101   1  12111</span>
01027 <span class="comment">   32     6  01110111   1  02121</span>
01028 <span class="comment">   33     6  11110110   1  12120</span>
01029 <span class="comment">   34     6  01111101   1  02211</span>
01030 <span class="comment">   35     6  11111100   1  12210</span>
01031 <span class="comment">   36     6  01111110   0  02220</span>
01032 <span class="comment"></span>
01033 <span class="comment">   37     5  10101011   1  11111</span>
01034 <span class="comment">   38     5  10001111   0  10121</span>
01035 <span class="comment">   39     5  10100111   0  11021</span>
01036 <span class="comment">   40     5  10101101   1  11111</span>
01037 <span class="comment">   41     5  00101111   0  01121</span>
01038 <span class="comment">   42     5  10101110   0  11120</span>
01039 <span class="comment">   43     5  10011011   0  10211</span>
01040 <span class="comment">   44     5  10110011   1  11111</span>
01041 <span class="comment">   45     5  10111001   0  11201</span>
01042 <span class="comment">   46     5  00111011   0  01211</span>
01043 <span class="comment">   47     5  10111010   0  11210</span>
01044 <span class="comment">   48     5  10010111   0  10121</span>
01045 <span class="comment">   49     5  10011101   0  10211</span>
01046 <span class="comment">   50     5  00011111   0  00221</span>
01047 <span class="comment">   51     5  10011110   0  10220</span>
01048 <span class="comment">   52     5  10110101   1  11111</span>
01049 <span class="comment">   53     5  00110111   0  01121</span>
01050 <span class="comment">   54     5  10110110   0  11120</span>
01051 <span class="comment">   55     5  00111101   0  01211</span>
01052 <span class="comment">   56     5  10111100   0  11210</span>
01053 <span class="comment">   57     5  00111110   0  01220</span>
01054 <span class="comment">   58     5  11001011   1  11111</span>
01055 <span class="comment">   59     5  11100011   0  12011</span>
01056 <span class="comment">   60     5  11101001   0  12101</span>
01057 <span class="comment">   61     5  01101011   0  02111</span>
01058 <span class="comment">   62     5  11101010   0  12110</span>
01059 <span class="comment">   63     5  11000111   0  11021</span>
01060 <span class="comment">   64     5  11001101   1  11111</span>
01061 <span class="comment">   65     5  01001111   0  01121</span>
01062 <span class="comment">   66     5  11001110   0  11120</span>
01063 <span class="comment">   67     5  11100101   0  12011</span>
01064 <span class="comment">   68     5  01100111   0  02021</span>
01065 <span class="comment">   69     5  11100110   0  12020</span>
01066 <span class="comment">   70     5  01101101   0  02111</span>
01067 <span class="comment">   71     5  11101100   0  12110</span>
01068 <span class="comment">   72     5  01101110   0  02120</span>
01069 <span class="comment">   73     5  11010011   1  11111</span>
01070 <span class="comment">   74     5  11011001   0  11201</span>
01071 <span class="comment">   75     5  01011011   0  01211</span>
01072 <span class="comment">   76     5  11011010   0  11210</span>
01073 <span class="comment">   77     5  11110001   0  12101</span>
01074 <span class="comment">   78     5  01110011   0  02111</span>
01075 <span class="comment">   79     5  11110010   0  12110</span>
01076 <span class="comment">   80     5  01111001   0  02201</span>
01077 <span class="comment">   81     5  11111000   0  12200</span>
01078 <span class="comment">   82     5  01111010   0  02210</span>
01079 <span class="comment">   83     5  11010101   1  11111</span>
01080 <span class="comment">   84     5  01010111   0  01121</span>
01081 <span class="comment">   85     5  11010110   0  11120</span>
01082 <span class="comment">   86     5  01011101   0  01211</span>
01083 <span class="comment">   87     5  11011100   0  11210</span>
01084 <span class="comment">   88     5  01011110   0  01220</span>
01085 <span class="comment">   89     5  01110101   0  02111</span>
01086 <span class="comment">   90     5  11110100   0  12110</span>
01087 <span class="comment">   91     5  01110110   0  02120</span>
01088 <span class="comment">   92     5  01111100   0  02210</span>
01089 <span class="comment"></span>
01090 <span class="comment">   93     4  10001011   0  10111</span>
01091 <span class="comment">   94     4  10100011   0  11011</span>
01092 <span class="comment">   95     4  10101001   0  11101</span>
01093 <span class="comment">   96     4  00101011   0  01111</span>
01094 <span class="comment">   97     4  10101010   0  11110</span>
01095 <span class="comment">   98     4  10000111   0  10021</span>
01096 <span class="comment">   99     4  10001101   0  10111</span>
01097 <span class="comment">  100     4  00001111   0  00121</span>
01098 <span class="comment">  101     4  10001110   0  10120</span>
01099 <span class="comment">  102     4  10100101   0  11011</span>
01100 <span class="comment">  103     4  00100111   0  01021</span>
01101 <span class="comment">  104     4  10100110   0  11020</span>
01102 <span class="comment">  105     4  00101101   0  01111</span>
01103 <span class="comment">  106     4  10101100   0  11110</span>
01104 <span class="comment">  107     4  00101110   0  01120</span>
01105 <span class="comment">  108     4  10010011   0  10111</span>
01106 <span class="comment">  109     4  10011001   0  10201</span>
01107 <span class="comment">  110     4  00011011   0  00211</span>
01108 <span class="comment">  111     4  10011010   0  10210</span>
01109 <span class="comment">  112     4  10110001   0  11101</span>
01110 <span class="comment">  113     4  00110011   0  01111</span>
01111 <span class="comment">  114     4  10110010   0  11110</span>
01112 <span class="comment">  115     4  00111001   0  01201</span>
01113 <span class="comment">  116     4  10111000   0  11200</span>
01114 <span class="comment">  117     4  00111010   0  01210</span>
01115 <span class="comment">  118     4  10010101   0  10111</span>
01116 <span class="comment">  119     4  00010111   0  00121</span>
01117 <span class="comment">  120     4  10010110   0  10120</span>
01118 <span class="comment">  121     4  00011101   0  00211</span>
01119 <span class="comment">  122     4  10011100   0  10210</span>
01120 <span class="comment">  123     4  00011110   0  00220</span>
01121 <span class="comment">  124     4  00110101   0  01111</span>
01122 <span class="comment">  125     4  10110100   0  11110</span>
01123 <span class="comment">  126     4  00110110   0  01120</span>
01124 <span class="comment">  127     4  00111100   0  01210</span>
01125 <span class="comment">  128     4  11000011   0  11011</span>
01126 <span class="comment">  129     4  11001001   0  11101</span>
01127 <span class="comment">  130     4  01001011   0  01111</span>
01128 <span class="comment">  131     4  11001010   0  11110</span>
01129 <span class="comment">  132     4  11100001   0  12001</span>
01130 <span class="comment">  133     4  01100011   0  02011</span>
01131 <span class="comment">  134     4  11100010   0  12010</span>
01132 <span class="comment">  135     4  01101001   0  02101</span>
01133 <span class="comment">  136     4  11101000   0  12100</span>
01134 <span class="comment">  137     4  01101010   0  02110</span>
01135 <span class="comment">  138     4  11000101   0  11011</span>
01136 <span class="comment">  139     4  01000111   0  01021</span>
01137 <span class="comment">  140     4  11000110   0  11020</span>
01138 <span class="comment">  141     4  01001101   0  01111</span>
01139 <span class="comment">  142     4  11001100   0  11110</span>
01140 <span class="comment">  143     4  01001110   0  01120</span>
01141 <span class="comment">  144     4  01100101   0  02011</span>
01142 <span class="comment">  145     4  11100100   0  12010</span>
01143 <span class="comment">  146     4  01100110   0  02020</span>
01144 <span class="comment">  147     4  01101100   0  02110</span>
01145 <span class="comment">  148     4  11010001   0  11101</span>
01146 <span class="comment">  149     4  01010011   0  01111</span>
01147 <span class="comment">  150     4  11010010   0  11110</span>
01148 <span class="comment">  151     4  01011001   0  01201</span>
01149 <span class="comment">  152     4  11011000   0  11200</span>
01150 <span class="comment">  153     4  01011010   0  01210</span>
01151 <span class="comment">  154     4  01110001   0  02101</span>
01152 <span class="comment">  155     4  11110000   0  12100</span>
01153 <span class="comment">  156     4  01110010   0  02110</span>
01154 <span class="comment">  157     4  01111000   0  02200</span>
01155 <span class="comment">  158     4  01010101   0  01111</span>
01156 <span class="comment">  159     4  11010100   0  11110</span>
01157 <span class="comment">  160     4  01010110   0  01120</span>
01158 <span class="comment">  161     4  01011100   0  01210</span>
01159 <span class="comment">  162     4  01110100   0  02110</span>
01160 <span class="comment"></span>
01161 <span class="comment">  163     3  10000011   0  10011</span>
01162 <span class="comment">  164     3  10001001   0  10101</span>
01163 <span class="comment">  165     3  00001011   0  00111</span>
01164 <span class="comment">  166     3  10001010   0  10110</span>
01165 <span class="comment">  167     3  10100001   0  11001</span>
01166 <span class="comment">  168     3  00100011   0  01011</span>
01167 <span class="comment">  169     3  10100010   0  11010</span>
01168 <span class="comment">  170     3  00101001   0  01101</span>
01169 <span class="comment">  171     3  10101000   0  11100</span>
01170 <span class="comment">  172     3  00101010   0  01110</span>
01171 <span class="comment">  173     3  10000101   0  10011</span>
01172 <span class="comment">  174     3  00000111   0  00021</span>
01173 <span class="comment">  175     3  10000110   0  10020</span>
01174 <span class="comment">  176     3  00001101   0  00111</span>
01175 <span class="comment">  177     3  10001100   0  10110</span>
01176 <span class="comment">  178     3  00001110   0  00120</span>
01177 <span class="comment">  179     3  00100101   0  01011</span>
01178 <span class="comment">  180     3  10100100   0  11010</span>
01179 <span class="comment">  181     3  00100110   0  01020</span>
01180 <span class="comment">  182     3  00101100   0  01110</span>
01181 <span class="comment">  183     3  10010001   0  10101</span>
01182 <span class="comment">  184     3  00010011   0  00111</span>
01183 <span class="comment">  185     3  10010010   0  10110</span>
01184 <span class="comment">  186     3  00011001   0  00201</span>
01185 <span class="comment">  187     3  10011000   0  10200</span>
01186 <span class="comment">  188     3  00011010   0  00210</span>
01187 <span class="comment">  189     3  00110001   0  01101</span>
01188 <span class="comment">  190     3  10110000   0  11100</span>
01189 <span class="comment">  191     3  00110010   0  01110</span>
01190 <span class="comment">  192     3  00111000   0  01200</span>
01191 <span class="comment">  193     3  00010101   0  00111</span>
01192 <span class="comment">  194     3  10010100   0  10110</span>
01193 <span class="comment">  195     3  00010110   0  00120</span>
01194 <span class="comment">  196     3  00011100   0  00210</span>
01195 <span class="comment">  197     3  00110100   0  01110</span>
01196 <span class="comment">  198     3  11000001   0  11001</span>
01197 <span class="comment">  199     3  01000011   0  01011</span>
01198 <span class="comment">  200     3  11000010   0  11010</span>
01199 <span class="comment">  201     3  01001001   0  01101</span>
01200 <span class="comment">  202     3  11001000   0  11100</span>
01201 <span class="comment">  203     3  01001010   0  01110</span>
01202 <span class="comment">  204     3  01100001   0  02001</span>
01203 <span class="comment">  205     3  11100000   0  12000</span>
01204 <span class="comment">  206     3  01100010   0  02010</span>
01205 <span class="comment">  207     3  01101000   0  02100</span>
01206 <span class="comment">  208     3  01000101   0  01011</span>
01207 <span class="comment">  209     3  11000100   0  11010</span>
01208 <span class="comment">  210     3  01000110   0  01020</span>
01209 <span class="comment">  211     3  01001100   0  01110</span>
01210 <span class="comment">  212     3  01100100   0  02010</span>
01211 <span class="comment">  213     3  01010001   0  01101</span>
01212 <span class="comment">  214     3  11010000   0  11100</span>
01213 <span class="comment">  215     3  01010010   0  01110</span>
01214 <span class="comment">  216     3  01011000   0  01200</span>
01215 <span class="comment">  217     3  01110000   0  02100</span>
01216 <span class="comment">  218     3  01010100   0  01110</span>
01217 <span class="comment">*/</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Nov 18 18:21:04 2008 for  AMS Software: Geometry Classes by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
